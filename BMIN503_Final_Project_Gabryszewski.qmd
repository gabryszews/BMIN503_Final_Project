---
title: "Dietary Determinants of Allergic, Immunologic, and Cardiometabolic Diseases"
subtitle: "BMIN5030/EPID600 Final Project"
author: "Stan Gabryszewski"
format: 
  html:
    css: styles.css
    theme: flatly
    page-layout: full
editor: visual
number-sections: true
embed-resources: true
execute: 
  warning: false
---

------------------------------------------------------------------------

## Overview {#sec-overview}

This project used data from the nationally representative National Health and Nutrition Examination Survey (NHANES) to explore links between dietary determinants and allergic, immunologic, and cardiometabolic outcomes in U.S. adults, focusing on those between the ages of 20 and 40. Using survey-weighted univariable and multivariable regression analyses, I examined whether diet quality - primarily assessed via the Dietary Inflammatory Index - and various sociodemographic (e.g., age, sex, race/ethnicity, poverty-income ratio), behavioral (e.g., alcohol, smoking), and clinical (e.g., body mass index \[BMI\], blood pressure, hemoglobin A1c \[HbA1c\], vitamin D level) features were associated with self-reported asthma, allergic rhinitis, inflammatory arthritis, eczema, food allergy, diabetes, and hypertension. In addition, I used exploratory machine learning models to identify predictors that may contribute to risk across these diseases.

I discussed this project with Dr. Robert Grundmeier (Professor of Pediatrics at CHOP and Penn, Department of Biomedical and Health Informatics) and Dr. Rich Tsui (Professor of Anesthesiology and Critical Care at CHOP and Penn, Department of Anesthesiology and Critical Care Medicine). With Dr. Grundmeier, I discussed cohort definitions, application of survey weights, and approach for regression analyses. With both Dr. Grundmeier and Dr. Tsui, I discussed the approach for machine learning analyses.

**GitHub repository link:** [Final Project Repo](https://github.com/gabryszews/BMIN503_Final_Project)

## Introduction {#sec-introduction}

Over the past several decades, rates of allergic conditions – including asthma, allergic rhinitis, food allergy, and eczema - have risen substantially worldwide, driven by mechanisms that remain only partially understood \[1\]. A concurrent increase has occurred in cardiometabolic diseases, such as obesity, hypertension, and diabetes \[2\]. Allergic, immunologic, and cardiometabolic conditions share comorbidity. Together, they reflect a state of immune dysregulation that occurs due to a complex interplay among genetic susceptibility, environmental exposures, and immune-metabolic pathways. There is growing recognition that dietary factors influence immune development beginning early in life and continuing into adulthood. Diet quality, nutrient intake patterns, and anthropometric factors such as adiposity influence inflammation, epithelial barrier function, and the gut microbiome, which in turn affect disease susceptibility \[3,4\]. While a modulatory role for diet has been been implicated in select allergic (e.g., asthma) and cardiometabolic (e.g., obesity) conditions \[5,6\], knowledge gaps remain about the potential modulatory role in other allergic and autoimmune diseases. This knowledge could help guide how dietary approaches might be integrated into clinical care to prevent or manage these chronic conditions.

NHANES is a continuous, nationally representative survey that integrates interviews, physical examinations, and laboratory assessments to characterize the health and nutritional status of the U.S. population. It provides detailed information on demographics, health behaviors, dietary recalls, biomarkers, anthropometrics, and clinical outcomes, making it well suited for population-level nutrition research \[7\]. The Dietary Inflammatory Index (DII) is an established, literature-derived score that quantifies the inflammatory potential of an individual’s diet based on intake of nutrients and food components known to influence systemic inflammation. To compute standardized DII values in NHANES, this study used the dietaryindexNDP package, which links NHANES dietary recall data with nutrient composition information from the U.S. Department of Agriculture’s Food and Nutrient Database for Dietary Studies (FNDDS) and food group equivalents from the Food Patterns Equivalents Database (FPED) \[8,9\]. Leveraging these tools, I examined associations between dietary, sociodemographic, and clinical factors and a set of allergic-immunologic outcomes (asthma, allergic rhinitis, inflammatory arthritis, eczema, and food allergy) as well as cardiometabolic outcomes (diabetes and hypertension). I specifically focused on adults aged 20-40 years, a sub-population that may be particularly amenable to dietary interventions aimed at disease prevention or management. In this study, I applied survey-weighted logistic regression along with exploratory machine learning models to assess whether dietary factors and related covariates are associated with risk across these various immune dysregulatory conditions.

This work is inherently multidisciplinary, bridging allergy–immunology, nutrition, epidemiology, and biomedical informatics. Informatics approaches were essential to this project, from extracting and integrating NHANES data to applying the survey design structure and implementing the regression and machine learning analyses. The integration of my prior training in allergy-immunology, clinical nutrition, epidemiology, and statistics with my current training in informatics uniquely equipped me to complete this project and interpret its findings with a cross-disciplinary lens. This project was supported by mentorship from Drs. Robert Grundmeier and Rich Tsui, whose guidance was instrumental in developing cohort definitions, applying survey-weighted design, and shaping the analytic approach for both the regression and machine learning analyses.

## Methods {#sec-methods}

**Data source, cohort extraction, and data harmonization**

Using NHANES, I performed a cross-sectional analysis focused on non-pregnant adults ages 20-40 years from 2005 to 2012. This age and time range were selected to target a younger adult population that may be more amenable to dietary interventions for prevention or management of chronic diseases. Additional reasons for this sub-population choice included (1) avoidance of incorporating the increasing medical complexity associated with older age, and (2) partial mitigation of missingness of key variables that were less available for other age groups across NHANES cycles. I pooled four continuous two-year NHANES cycles (2005-2006, 2007-2008, 2009-2010, and 2011-2012). For the main analyses (asthma, allergic rhinitis, inflammatory arthritis, diabetes, hypertension), data from the full pooled period (2005–2012) were used. Because eczema and food allergy were only measured in select cycles, I additionally constructed time-restricted subcohorts for eczema (2005-2006) and food allergy (2007-2010).

Covariates included sociodemographic variables (e.g., age, sex, race/ethnicity), clinical characteristics (e.g., BMI, waist-to-height ratio, vitamin D \[25(OH)D\] level), and self-reported allergic-immunologic conditions (asthma, allergic rhinitis, inflammatory arthritis \[i.e., rheumatoid or psoriatic arthritis\], eczema, food allergy) and cardiometabolic diseases (diabetes, hypertension). Two-year survey weights were rescaled to generate weights for analysis of pooled NHANES cycles. Data from multiple NHANES modules were merged into a single dataset, and variables were harmonized by recoding them into consistent categories across cycles. Using the dietaryindexNDP package, the Dietary Inflammatory Index (DII) was computed based on 24-hour dietary recall data and was represented as both as a continuous score (with and without alcohol intake included) and as quartiles (Q1–Q4), corresponding to most anti-inflammatory to most pro-inflammatory, as previously described \[10\]. To reduce the influence of extreme values and to create clinically meaningful comparison groups, select variables (e.g., BMI, vitamin D levels) were converted into quartiles prior to incorporation into models. I performed data manipulation with the tidyverse set of packages, formatted outputs with broom and scales packages, generated figures using the ggplot2 package, and generated tables using the gt package.

All extracted variables, their types (i.e., continuous, categorical, binary), distributions, and missingness are summarized in **Table 1**. In general, for sociodemographic and behavioral variables, missingness was low, with most variables (e.g., age, sex, education, insurance, smoking, physical activity, family history) exhibiting a missingness rate of less than 2%, while other variables (e.g. race/ethnicity, alcohol use, poverty-income ratio, food security) showed a range of missingness rates between 7% and 20%. For cardiometabolic and nutrient labs, the missingness rate was 8%-10%. The rate of missingness for primary clinical outcomes was low (less than 1%). For food allergy and eczema, the missingness (calculated relative to the full cohort) was expected given the unavailability of these clinical outcomes in many survey cycles. Hence, time-restricted comparator cohorts were used for secondary analyses for these specific clinical outcomes. Subsequent regression and machine learning analyses used complete-case data.

**Weighted prevalence analysis**

Using the survey package, the survey-weighted prevalence of all allergic, immunologic, and cardiometabolic conditions was determined. In addition, to assess how prevalence varied by dietary inflammatory status, survey-weighted prevalence was determined within DII quartiles (Q1-Q4). Statistical significance was determined in survey-weighted logistic regression models of each outcome on DII quartile, comparing Q2-Q4 with Q1 using Wald tests.

**Univariable and multivariable regression analyses**

Survey-weighted regression analyses were performed using the svyglm function in the survey package. After assessing models for overdispersion, quasibinomial survey-weighted logistic regression was employed. First, univariable analyses were performed to examine associations between each outcome and a core set of sociodemographic, behavioral, clinical, and dietary predictors. An additional exploratory set of univariable analyses evaluated associations between each outcome and individual DII nutrient components. For all univariable models, odds ratios (ORs) with 95% confidence intervals (CIs) were reported, and p values were adjusted using the Benjamini-Hochberg method to account for multiple comparisons.

Next, survey-weighted multivariable regression analyses were performed to evaluate adjusted associations between continuous DII and each disease outcome. Three models were constructed. Model 1 adjusted for age and sex. Model 2 additionally adjusted for race/ethnicity, insurance status, poverty-income ratio, and education level. Model 3 further adjusted for BMI category, physical activity, and smoking status. For each model, the OR, 95% CIs and p values were determined, and results were visualized using Forest plots.

**Effect modification analyses**

I assessed whether the association between continuous DII and each disease outcome differed by sex, BMI category, or vitamin D category using survey-weighted logistic regression models that included all Model 3 covariates from the multivariable regression analyses. Sex contributed one interaction term (DII x sex), whereas the multi-category BMI and vitamin D variables contributed multiple interaction terms with DII. I determined stratum-specific ORs and 95% CIs for DII within each modifier level. Statistical significance of effect modification was evaluated using Wald tests combining all interaction coefficients for each modifier.

**Machine learning analyses**

I developed exploratory machine learning models to predict disease outcomes (asthma, allergic rhinitis, inflammatory arthritis, hypertension, diabetes, eczema, and food allergy) using the tidymodels set of packages for preprocessing, data sampling, model tuning, and performance evaluation. Two predictor sets were examined. Set 1 included core sociodemographic, behavioral, anthropometric, and clinical variables as well as continuous DII scores (23 variables). Set 2 included individual nutrient predictors (26 variables). Four algorithms were trained for each outcome, namely logistic regression (LR), LASSO-penalized logistic regression (glmnet package), Random Forest (RF; randomForest package), and XGBoost (XGB; xgboost package). Logistic regression was chosen as a baseline comparator model, LASSO was chosen for its ability to shrink coefficients and perform variable selection, and RF and XGB were chosen due to their ability to capture complex non-linear relationships.

For each outcome and predictor set, data were split into a training set (80%) and a test set (20%). Within the training set, 10-fold cross-validation was used for preprocessing and hyperparameter tuning. Preprocessing steps were implemented using tidymodels recipes. Hyperparameters for LASSO (penalty), RF (mtry), and XGB (number of trees, tree depth, learning rate) were tuned using the cross-validated area under the receiver operating characteristic curve (AUROC). Model performance on the test set was quantified using AUROC. To identify the topmost predictors, I computed model-specific variable importance scores using the vip package. For LR models, variable importance referred to the absolute value of standardized regression coefficients. For LASSO models, variable importance was based on the absolute value of the penalized coefficients after shrinkage. For RF models, variable importance was derived from tree-based split metrics (i.e., increase in node purity associated with each variable). Finally, for XGB, variable importance reflected the gain (i.e., how much each predictor improved the model’s accuracy when used in boosted trees).

**Code to install and load packages**

```{r}
#| eval: false
# Install packages
install.packages("broom")
install.packages("ggplot2")
install.packages("glmnet")
install.packages("gt")
install.packages("nhanesA")
install.packages("randomForest")
install.packages("scales")
install.packages("survey")
install.packages("tidyverse")
install.packages("tidymodels")
install.packages("xgboost")
install.packages("vip")

# Install dietaryindex packages
devtools::install_github("zxucmu/dietaryindexNDP", ref = "dietaryindexNDP_1.0.0")
```

```{r}
# Load packages
library(broom)
library(dietaryindexNDP)
library(ggplot2)
library(glmnet)
library(gt)
library(nhanesA)
library(randomForest)
library(scales)
library(survey)
library(tidymodels)
library(tidyverse)
library(xgboost)
library(vip)
```

```{r}
#| label: setup
#| include: false

# Figure rendering settings 
knitr::opts_chunk$set(
  fig.width  = 9,        
  fig.height = 6,        
  out.width  = "100%",   
  fig.align  = "center", 
  fig.retina = 2         
)
```

**Code to generate master analytic dataset and summarize variable types, distributions, and missingness**

The code below was used to generate the master analytic dataset for subsequent regression and machine learning analyses. Briefly, custom helper functions were used with the nhanesA package to streamline downloading NHANES modules of interest (i.e., demographics, psychosocial variables, medical conditions, anthropometrics, laboratory results, dietary variables, etc.) across four survey cycles (2005–2012). These were useful for exploring survey-cycle and variable combinations while optimizing the cohort parameters for the final cohort selection. The set of tidyverse packages was used to clean and merge data. I then used the dietaryindexNDP package to compute Dietary Inflammatory Index (DII) scores (with and without alcohol) and individual nutrient components. All cleaned modules were joined by the participant ID into a single dataset. I then harmonized disease outcomes (i.e., asthma, allergic rhinitis, inflammatory arthritis, eczema, food allergy, diabetes, hypertension) and converted selected variables (e.g., BMI, vitamin D level) into clinically relevant categories. The cohort was restricted to non-pregnant adults 20-40 years of age, and NHANES sampling weights were rescaled to account for pooling of survey cycles. Using the survey package, I generated outcome-specific analytic subsets with corresponding mobile examination center (MEC)-weighted survey designs for subsequent regression analyses. A data dictionary table (**Table 1**) summarizes all variables, their types, sample sizes, value ranges, categorical levels, and missingness. Additional coding details are included as annotations within the code chunk below.

```{r}
# Helper functions-----------------------------------------------------------------------------
## Helper function to load NHANES module across survey cycles, including options to restrict to select variables and provide status summaries
load_nhanes_module <- function(module, cycles_vec = cycles,
                               keep_vars = NULL,
                               quiet = TRUE) { # set to FALSE for debugging messages
  module_years <- paste0(module, "_", cycles_vec)
  
  status <- tibble(
    file_tag = module_years,
    ok       = FALSE,
    n_rows   = NA_integer_,
    note     = NA_character_
  )
  
  dfs <- vector("list", length(module_years))
  
  for (i in seq_along(module_years)) {
    x <- module_years[i]
    
    out <- tryCatch(
      {
        if (!quiet) {
          message("Attempting to download: ", x)
        }
        
        df <- nhanes(x) |> as.data.frame()
        
        if (!is.null(keep_vars)) {
          df <- df |> select(any_of(keep_vars))
        }
        
        n <- nrow(df)
        status$n_rows[i] <- n
        
        if (n == 0) {
          status$ok[i]   <- FALSE
          status$note[i] <- "Downloaded, 0 rows"
          if (!quiet) {
            warning("File ", x, " downloaded but has 0 rows.")
          }
          df <- NULL
        } else {
          status$ok[i]   <- TRUE
          status$note[i] <- "Loaded"
          df$file_tag    <- x
        }
        
        df
      },
      error = function(e) {
        status$ok[i]   <- FALSE
        status$note[i] <- paste("ERROR:", conditionMessage(e))
        if (!quiet) {
          warning("File ", x, " could not be downloaded: ", conditionMessage(e))
        }
        return(NULL)
      }
    )
    
    dfs[[i]] <- out
  }
  
  dfs_nonempty <- dfs[!vapply(dfs, is.null, logical(1))]
  
  if (!quiet) {
    message("\nSummary for module ", module, ":")
    print(status)
  }
  
  if (length(dfs_nonempty) == 0) {
    stop("No cycles successfully downloaded for module: ", module)
  }
  
  out <- bind_rows(dfs_nonempty)
  
  ### Missing variables filled with NA
  if (!is.null(keep_vars)) {
    missing_vars <- setdiff(keep_vars, names(out))
    if (length(missing_vars) > 0) {
      for (v in missing_vars) {
        out[[v]] <- NA_real_
      }
    }
  }
  out
}

## Helper function to convert yes/no (1/2) variables into 0/1
to01 <- function(x) {
  x <- as.character(x)
  case_when(
    x %in% c("1", "Yes", "YES", "yes") ~ 1,
    x %in% c("2", "No",  "NO",  "no")  ~ 0,
    TRUE ~ NA_real_
  )
}

## Helper function to convert survey cycle numbers to cycle labels
cycle_label <- function(s) {
  years <- str_extract(as.character(s), "\\d{4}-\\d{4}")
  
  case_when(
    !is.na(years) ~ years,
    TRUE ~ recode(
      as.numeric(s),
      `4` = "2005-2006",
      `5` = "2007-2008",
      `6` = "2009-2010",
      `7` = "2011-2012",
      .default = NA_character_
    )
  )
}

## Helper function to summarize variable availability and missingness by cycle
check_var_availability <- function(data, vars = NULL) {
  
  if (is.null(vars)) {
    vars <- setdiff(
      names(data),
      c(
        "seqn", "wtint2yr", "wtmec2yr", "wtint8yr", "wtmec8yr",
        "sdmvpsu", "sdmvstra", "sddsrvyr", "cycle_str"
      )
    )
  }
  
  map_dfr(vars, function(v) {
    data |>
      group_by(cycle = sddsrvyr) |>
      summarise(
        variable      = v,
        total         = n(),
        n_nonmissing  = sum(!is.na(.data[[v]])),
        n_missing     = sum(is.na(.data[[v]])),
        prop_missing  = mean(is.na(.data[[v]])),
        .groups       = "drop"
      )
  }) |>
    arrange(variable, cycle)
}

## Restrict analysis NHANES cycles between 2005 and 2012 (i.e., D–G)
cycles <- c("D", "E", "F", "G")


# Load NHANES modules--------------------------------------------------------------------------
## Load demographic variables within DEMO module (i.e., demographics, survey design variables)
demo_keep <- c(
  "SEQN",        # Participant ID
  "RIDAGEYR",    # Age
  "RIAGENDR",    # Sex (1 = Male, 2 = Female)
  "RIDRETH1",    # Race/ethnicity (5-level)
  "DMDEDUC2",    # Education level
  "INDFMPIR",    # Poverty-income ratio
  "SDDSRVYR",    # Survey cycle indicator
  "SDMVPSU",     # Primary sampling unit (PSU) for survey design
  "SDMVSTRA",    # Stratification variable for survey design
  "WTINT2YR",    # 2-year interview weight
  "WTMEC2YR",    # 2-year MEC exam weight
  "RIDEXPRG"     # Pregnancy status for females
)
demo <- load_nhanes_module("DEMO", keep_vars = demo_keep)

## Load medical variables within MCQ module (i.e., asthma, family history of asthma, arthritis)
mcq_keep <- c(
  "SEQN",
  "MCQ010",   # Asthma
  "MCQ300B",  # Family history asthma
  "MCQ160A",  # Arthritis yes/no
  "MCQ190",   # Arthritis type (2005–08)
  "MCQ191",   # Arthritis type (2009–10)
  "MCQ195"    # Arthritis type (2011–12)
)
mcq <- load_nhanes_module("MCQ", keep_vars = mcq_keep)

## Load eczema and allergic rhinitis data within AGQ module for 2005–2006
agq_d <- load_nhanes_module(
  "AGQ",
  cycles_vec = "D",
  keep_vars = c("SEQN","AGQ010","AGQ180")
)

## Load allergic rhinitis data within RDQ module for 2007–2012
rdq <- load_nhanes_module(
  "RDQ",
  cycles_vec = c("E","F","G"),
  keep_vars = c("SEQN","AGQ030")
)

## Load food allergy data within DBQ module for 2007–2010
dbq <- load_nhanes_module("DBQ", keep_vars = c("SEQN","DBQ920"))

## Load diabetes status within DIQ module
diq <- load_nhanes_module("DIQ", keep_vars = c("SEQN","DIQ010"))

## Load hypertension within BPQ module
bpq <- load_nhanes_module("BPQ", keep_vars = c("SEQN","BPQ020"))

## Load anthropometrics within BMX module
bmx <- load_nhanes_module(
  "BMX",
  keep_vars = c("SEQN","BMXBMI","BMXWAIST","BMXHT","BMXWT")
)

## Load systolic and diastolic blood pressure readings within BPX module
bp <- load_nhanes_module(
  "BPX",
  keep_vars = c(
    "SEQN",
    "BPXSY1","BPXSY2","BPXSY3","BPXSY4",
    "BPXDI1","BPXDI2","BPXDI3","BPXDI4"
  )
)

## Load serum vitamin D [25(OH)D] measurements within VID module
vid <- load_nhanes_module(
  "VID",
  keep_vars = c("SEQN", "LBXVIDMS", "LBXVIDLC", "LBDVIDMS")
)

## Load lifetime and current smoking status within SMQ module
smq <- load_nhanes_module("SMQ", keep_vars = c("SEQN","SMQ020","SMQ040"))

## Load health insurance coverage within HIQ module
hiq <- load_nhanes_module("HIQ", keep_vars = c("SEQN","HIQ011"))

## Load household food security within FSQ module
fsq <- load_nhanes_module("FSQ", keep_vars = c("SEQN","FSDHH"))

## Load alcohol consumption within ALQ module
alq <- load_nhanes_module("ALQ", keep_vars = c("SEQN","ALQ101","ALQ130"))

## Load HbA1c within GHB module
hba1c <- load_nhanes_module("GHB", keep_vars = c("SEQN","LBXGH"))

## Load total and HDL cholesterol
tchol <- load_nhanes_module("TCHOL", keep_vars = c("SEQN","LBXTC"))
hdl   <- load_nhanes_module("HDL",   keep_vars = c("SEQN","LBDHDD"))

## Load physical activity variables within PAQ module
paq_keep <- c("SEQN","PAQ650","PAQ665","PAD200","PAD320")
paq <- load_nhanes_module("PAQ", keep_vars = paq_keep)

# Dietary Inflammatory Index (DII)-------------------------------------------------------------
## Define NHANES cycles (2005–2012)
dii_cycles <- c("0506", "0708", "0910", "1112")

## Obtain 24-hour DII results for NHANES cycle
get_dii_cycle <- function(cyc) {
  message("Obtain DII for NHANES cycle ", cyc, " (Day 1)...")
  
  DII_NHANES_PLUS_RESULT(
    NHANESCycle = cyc,
    DAY         = "first"
  ) |>
    mutate(cycle_code_ndp = cyc)
}

## Obtain and pool DII data across cycles
dii_all <- dii_cycles |>
  map_dfr(get_dii_cycle)

## Keep DII total scores (with and without alcohol) and nutrient components
dii_clean <- dii_all |>
  transmute(
    seqn         = SEQN,
    dii_etoh_raw = DII_ALL,      
    dii_raw      = DII_NOETOH,   
    kcal         = KCAL,
    carb         = CARB,
    protein      = PROTEIN,
    totalfat     = TOTALFAT,
    satfat       = SATFAT,
    pufa         = PUFA,
    mufa         = MUFA,
    n3fat        = N3FAT,
    n6fat        = N6FAT,
    choles       = CHOLES,
    vitA         = VITA,
    bcarotene    = BCAROTENE,
    vitC         = VITC,
    vitE         = VITE,
    vitB6        = VITB6,
    vitB12       = VITB12,
    folicacid    = FOLICACID,
    thiamin      = THIAMIN,
    riboflavin   = RIBOFLAVIN,
    niacin       = NIACIN,
    iron         = IRON,
    mg           = MG,
    zn           = ZN,
    se           = SE,
    fiber        = FIBER,
    caffeine     = CAFFEINE
  ) |>
  mutate(
    dii      = dii_raw,      
    dii_etoh = dii_etoh_raw
  )

## Define full set of DII component nutrient variables
dii_component_vars <- c(
  "kcal", "carb", "protein", "totalfat", "satfat",
  "pufa", "mufa", "n3fat", "n6fat", "choles",
  "vitA", "bcarotene", "vitC", "vitE",
  "vitB6", "vitB12", "folicacid",
  "thiamin", "riboflavin", "niacin",
  "iron", "mg", "zn", "se",
  "fiber", "caffeine"
)

# Data cleaning and harmonization -------------------------------------------------------------
## Harmonize physical activity variables across NHANES cycles
paq_clean <- paq |>
  transmute(
    seqn   = SEQN,
    paq650 = PAQ650,   # Vigorous recreational activity ≥10 minutes (2007+)
    paq665 = PAQ665,   # Moderate recreational activity ≥10 minutes (2007+)
    pad200 = PAD200,   # Vigorous activity ≥10 minutes over past 30 days (2005–06)
    pad320 = PAD320    # Moderate activity ≥10 minutes over past 30 days (2005–06)
  )

## Clean demographic and design variables and derive numeric cycle code
demo_clean <- demo |>
  mutate(
    sddsrvyr_label = as.character(SDDSRVYR),
    sddsrvyr = case_when(
      grepl("2005-2006", sddsrvyr_label) ~ 4,
      grepl("2007-2008", sddsrvyr_label) ~ 5,
      grepl("2009-2010", sddsrvyr_label) ~ 6,
      grepl("2011-2012", sddsrvyr_label) ~ 7,
      TRUE                               ~ NA_real_
    )
  ) |>
  transmute(
    seqn      = SEQN,                   # Participant ID
    age       = as.numeric(RIDAGEYR),   # Age (years)
    sex_raw   = RIAGENDR,               # Sex
    race_raw  = RIDRETH1,               # Race/ethnicity (1–5)
    educ_raw  = DMDEDUC2,               # Education level
    pir       = INDFMPIR,               # Poverty-income ratio
    sddsrvyr,
    cycle_str = cycle_label(sddsrvyr),  # Cycle label
    sdmvpsu   = SDMVPSU,                # PSU for survey design
    sdmvstra  = SDMVSTRA,               # Stratum for survey design
    wtint2yr  = WTINT2YR,               # Interview weight (2-year)
    wtmec2yr  = WTMEC2YR,               # MEC weight (2-year)
    preg      = RIDEXPRG                # Pregnancy status
  )

## Clean medical conditions and derive indicators for asthma, family history of asthma, and arthritis
mcq_clean <- mcq |>
  transmute(
    seqn           = SEQN,      # Participant ID
    asthma_raw     = MCQ010,    # Asthma
    fh_asthma_raw  = MCQ300B,   # Family history asthma
    arthritis_raw  = MCQ160A,   # Ever arthritis
    mcq190         = MCQ190,    # Arthritis type (2005–08)
    mcq191         = MCQ191,    # Arthritis type (2009–10)
    mcq195         = MCQ195     # Arthritis type (2011–12)
  ) |>
  mutate(
    asthma         = to01(asthma_raw),
    fh_asthma      = to01(fh_asthma_raw),
    arthritis_ever = to01(arthritis_raw)
  )

## Derive eczema status in 2005–2006 cycle
eczema_clean <- demo_clean |>
  select(seqn, sddsrvyr) |>
  left_join(
    agq_d |>
      transmute(
        seqn       = SEQN,
        agq180_ecz = to01(AGQ180) # Eczema code
      ),
    by = "seqn"
  ) |>
  mutate(
    ad = if_else(sddsrvyr == 4, agq180_ecz, NA_real_)
  ) |>
  select(seqn, ad)

## Derive food allergy status in 2007–2010 cycles
fa_clean <- demo_clean |>
  select(seqn, sddsrvyr) |>
  left_join(
    dbq |>
      transmute(
        seqn      = SEQN,
        dbq920_fa = to01(DBQ920) # Food allergy code
      ),
    by = "seqn"
  ) |>
  mutate(
    fa = if_else(sddsrvyr %in% c(5, 6), dbq920_fa, NA_real_)
  ) |>
  select(seqn, fa)

## Harmonize allergic rhinitis across 2005–2006 and 2007–2012
ar_clean <- demo_clean |>
  select(seqn, sddsrvyr) |>
  left_join(
    agq_d |>
      transmute(seqn = SEQN, ar_agq010 = to01(AGQ010)),  # AR code (2005–06)
    by = "seqn"
  ) |>
  left_join(
    rdq |>
      transmute(seqn = SEQN, ar_agq030_rdq = to01(AGQ030)), # AR code (2007–12)
    by = "seqn"
  ) |>
  mutate(
    ar = case_when(
      sddsrvyr == 4            ~ ar_agq010,
      sddsrvyr %in% c(5, 6, 7) ~ ar_agq030_rdq,
      TRUE                     ~ NA_real_
    )
  ) |>
  select(seqn, ar)

## Derive diabetes indicator from DIQ010
diq_clean <- diq |>
  transmute(
    seqn = SEQN,
    dm2_diag_chr = as.character(DIQ010)
  ) |>
  mutate(
    dm2 = case_when(
      dm2_diag_chr %in% c("1", "Yes")                ~ 1,
      dm2_diag_chr %in% c("2","No","3","Borderline") ~ 0,
      TRUE ~ NA_real_
    )
  ) |>
  select(seqn, dm2)

## Derive hypertension indicator from BPQ020
bpq_clean <- bpq |>
  transmute(
    seqn    = SEQN,
    htn_chr = as.character(BPQ020)
  ) |>
  mutate(
    htn = case_when(
      htn_chr %in% c("1","Yes") ~ 1,
      htn_chr %in% c("2","No")  ~ 0,
      TRUE ~ NA_real_
    )
  ) |>
  select(seqn, htn)

## Clean anthropometrics and derive standard measures
bmx_clean <- bmx |>
  transmute(
    seqn      = SEQN,
    bmi       = BMXBMI,   # Body mass index (kg/m^2)
    waist_cm  = BMXWAIST, # Waist circumference (cm)
    height_cm = BMXHT,    # Standing height (cm)
    weight_kg = BMXWT     # Weight (kg)
  )

## Compute mean systolic and diastolic blood pressures across readings
bp_clean <- bp |>
  mutate(
    sbp_mean = rowMeans(across(BPXSY1:BPXSY4), na.rm = TRUE),
    dbp_mean = rowMeans(across(BPXDI1:BPXDI4), na.rm = TRUE),
    dbp_mean = if_else(dbp_mean == 0, NA_real_, dbp_mean)
  ) |>
  transmute(
    seqn     = SEQN,
    sbp_mean = if_else(is.nan(sbp_mean), NA_real_, sbp_mean),
    dbp_mean = if_else(is.nan(dbp_mean), NA_real_, dbp_mean)
  )

## Harmonize vitamin D [25(OH)D] across laboratory methods (take first non-missing value)
vid_clean <- vid |>
  mutate(
    vitD25oh = coalesce(LBXVIDMS, LBXVIDLC, LBDVIDMS)
  ) |>
  transmute(
    seqn     = SEQN,
    vitD25oh = vitD25oh
  )

## Derive smoking status (never, former, current)
smq_clean <- smq |>
  transmute(
    seqn       = SEQN,
    smoked_100 = as.numeric(SMQ020),
    smoke_now  = as.numeric(SMQ040)
  ) |>
  mutate(
    smoking = case_when(
      smoked_100 == 2 ~ "Never",
      smoked_100 == 1 & smoke_now == 3 ~ "Former",
      smoked_100 == 1 & smoke_now %in% c(1,2) ~ "Current",
      TRUE ~ NA_character_
    )
  )

## Derive insurance indicator using HIQ011
hiq_clean <- hiq |>
  transmute(
    seqn    = SEQN,
    insured = to01(HIQ011)
  )

## Classify household food security into categories
fsq_clean <- fsq |>
  transmute(
    seqn = SEQN,
    foodsec_raw = as.numeric(FSDHH),
    food_security = case_when(
      foodsec_raw == 1 ~ "Full",
      foodsec_raw == 2 ~ "Marginal",
      foodsec_raw == 3 ~ "Low",
      foodsec_raw == 4 ~ "Very low",
      TRUE ~ NA_character_
    )
  )

## Derive alcohol indicator from ALQ101
alq_clean <- alq |>
  transmute(
    seqn        = SEQN,
    any_alcohol = case_when(
      ALQ101 %in% c(1, "1", "Yes") ~ 1,
      ALQ101 %in% c(2, "2", "No")  ~ 0,
      TRUE                         ~ NA_real_
    )
  )

## Keep HbA1c
hba1c_clean <- hba1c |>
  transmute(
    seqn  = SEQN,
    hba1c = LBXGH
  )

## Keep total and HDL cholesterol
tchol_clean <- tchol |> transmute(seqn = SEQN, tchol = LBXTC)
hdl_clean   <- hdl   |> transmute(seqn = SEQN, hdl   = LBDHDD)


# Merge modules and define analytic cohort ----------------------------------------------------
## Merge all cleaned modules to construct single NHANES analytic dataset
nhanes_all <- demo_clean |>
  left_join(mcq_clean,    by = "seqn") |>
  left_join(eczema_clean, by = "seqn") |>
  left_join(fa_clean,     by = "seqn") |>
  left_join(ar_clean,     by = "seqn") |>
  left_join(bmx_clean,    by = "seqn") |>
  left_join(bp_clean,     by = "seqn") |>
  left_join(vid_clean,    by = "seqn") |>
  left_join(smq_clean,    by = "seqn") |>
  left_join(hiq_clean,    by = "seqn") |>
  left_join(fsq_clean,    by = "seqn") |>
  left_join(alq_clean,    by = "seqn") |>
  left_join(hba1c_clean,  by = "seqn") |>
  left_join(tchol_clean,  by = "seqn") |>
  left_join(hdl_clean,    by = "seqn") |>
  left_join(dii_clean,    by = "seqn") |>
  left_join(diq_clean,    by = "seqn") |>
  left_join(bpq_clean,    by = "seqn") |>
  left_join(paq_clean,    by = "seqn")

## Restrict analytic cohort and derive all final variables used in regression and machine learning analyses
nhanes_analytic <- nhanes_all |>
  ### Restrict to adults 20–40 years old, 2005–2012
  filter(
    !is.na(sddsrvyr),
    sddsrvyr %in% 4:7,
    age >= 20, age <= 40
  ) |>
  ### Exclude pregnant subjects
  filter(
    is.na(preg) |
      !preg %in% c("Yes, positive lab pregnancy test or self-reported pregnant at exam")
  ) |>
  mutate(
    ### Multi-cycle weights (pooled 8-year weights over 4 cycles)
    wtint8yr = wtint2yr / length(cycles),
    wtmec8yr = wtmec2yr / length(cycles),
    
    ### Sex factor
    sex = case_when(
      sex_raw %in% c(1, "1") ~ "Male",
      sex_raw %in% c(2, "2") ~ "Female",
      as.character(sex_raw) == "Male"   ~ "Male",
      as.character(sex_raw) == "Female" ~ "Female",
      TRUE ~ NA_character_
    ),
    sex = factor(sex, levels = c("Male", "Female")),
    
    ### Race/ethnicity factor
    race = case_when(
      race_raw %in% c(3, "3", "Non-Hispanic White")  ~ "Non-Hispanic White",
      race_raw %in% c(4, "4", "Non-Hispanic Black")  ~ "Non-Hispanic Black",
      race_raw %in% c(1, "1", "Mexican American")    ~ "Mexican American",
      race_raw %in% c(2, "2", "Other Hispanic")      ~ "Other Hispanic",
      race_raw %in% c(5, "5")                        ~ "Other/multiracial",
      TRUE                                           ~ NA_character_
    ),
    race = factor(
      race,
      levels = c(
        "Non-Hispanic White",
        "Non-Hispanic Black",
        "Mexican American",
        "Other Hispanic",
        "Other/multiracial"
      )
    ),
    
    ### Education factor
    educ_factor_raw = factor(educ_raw),
    educ = case_when(
      educ_factor_raw %in% c(
        "Less Than 9th Grade",
        "Less than 9th grade"
      ) ~ "<9 years",
      
      educ_factor_raw %in% c(
        "9-11th Grade (Includes 12th grade with no diploma)",
        "9-11th grade (Includes 12th grade with no diploma)",
        "High School Grad/GED or Equivalent",
        "High school graduate/GED or equivalent"
      ) ~ "9–12 years",
      
      educ_factor_raw %in% c(
        "Some College or AA degree",
        "Some college or AA degree",
        "College Graduate or above",
        "College graduate or above"
      ) ~ ">12 years",
      
      TRUE ~ NA_character_
    ),
    educ = factor(
      educ,
      levels  = c("<9 years","9–12 years",">12 years")
    ),
    
    ### Smoking factor
    smoking = factor(
      smoking,
      levels = c("Never", "Former", "Current")
    ),
    
    ### Physical activity factor
    phys_act = case_when(
      # 2005–2006 (sddsrvyr == 4): PAD200 / PAD320
      sddsrvyr == 4 & to01(pad200) == 1 ~ "Intense",
      sddsrvyr == 4 & to01(pad200) != 1 & to01(pad320) == 1 ~ "Moderate",
      sddsrvyr == 4 & to01(pad200) == 0 & to01(pad320) == 0 ~ "Sedentary",
      
      # 2007–2012 (sddsrvyr %in% 5:7): PAQ650 / PAQ665
      sddsrvyr %in% c(5, 6, 7) & as.character(paq650) == "Yes" ~ "Intense",
      sddsrvyr %in% c(5, 6, 7) &
        as.character(paq650) == "No" & as.character(paq665) == "Yes" ~ "Moderate",
      sddsrvyr %in% c(5, 6, 7) &
        as.character(paq650) == "No" & as.character(paq665) == "No"  ~ "Sedentary",
      
      TRUE ~ NA_character_
    ),
    phys_act = factor(
      phys_act,
      levels = c("Sedentary","Moderate","Intense")
    ),
    
    ### Food security factor
    food_sec = factor(
      food_security,
      levels = c("Full","Marginal","Low","Very low"),
      ordered = TRUE
    ),
    
    ### Insurance factor
    insur = factor(
      case_when(
        insured == 1 ~ "Yes",
        insured == 0 ~ "No",
        TRUE ~ NA_character_
      ),
      levels = c("No", "Yes")
    ),
    
    ### Alcohol factor
    alcohol = factor(
      case_when(
        any_alcohol == 0 ~ "No",
        any_alcohol == 1 ~ "Yes",
        TRUE ~ NA_character_
      ),
      levels = c("No", "Yes")
    ),
    
    ### Validity flags for outcomes with restricted survey windows
    ad_valid = sddsrvyr == 4,          # Eczema (2005–06)
    fa_valid = sddsrvyr %in% c(5, 6),  # Food allergy (2007–10)
    
    ### Inflammatory arthritis based on multiple arthritis questions
    inflam_arthritis = {
      mcq190_chr <- as.character(mcq190)
      mcq191_chr <- as.character(mcq191)
      mcq195_chr <- as.character(mcq195)
      
      case_when(
        #### Denial of ever having arthritis
        arthritis_ever == 0 ~ 0,
        
        #### 2005–2006 and 2007–2008: MCQ190 arthritis type
        arthritis_ever == 1 & sddsrvyr %in% c(4, 5) &
          grepl("Rhe", mcq190_chr, ignore.case = TRUE) ~ 1,
        arthritis_ever == 1 & sddsrvyr %in% c(4, 5) &
          grepl("Ost|Osteo|Oth", mcq190_chr, ignore.case = TRUE) ~ 0,
        
        #### 2009–2010: MCQ191 arthritis type 
        arthritis_ever == 1 & sddsrvyr == 6 &
          (grepl("Rhe", mcq191_chr, ignore.case = TRUE) |
             grepl("Pso", mcq191_chr, ignore.case = TRUE)) ~ 1,
        arthritis_ever == 1 & sddsrvyr == 6 &
          grepl("Ost|Osteo|Oth", mcq191_chr, ignore.case = TRUE) ~ 0,
        
        #### 2011–2012: MCQ195 arthritis type
        arthritis_ever == 1 & sddsrvyr == 7 &
          (grepl("Rhe", mcq195_chr, ignore.case = TRUE) |
             grepl("Pso", mcq195_chr, ignore.case = TRUE)) ~ 1,
        arthritis_ever == 1 & sddsrvyr == 7 &
          grepl("Ost|Osteo|Oth", mcq195_chr, ignore.case = TRUE) ~ 0,
        
        TRUE ~ NA_real_
      )
    },
    
    ### Final inflammatory arthritis, diabetes, and hypertension indicators
    arthritis = inflam_arthritis,
    diabetes  = dm2,
    htn       = htn,
  
    ### Family history of asthma
    fh_asthma = fh_asthma,
    
    ### Anthropometric ratio and non-HDL cholesterol
    whtr    = waist_cm / height_cm,                           
    non_hdl = if_else(!is.na(tchol) & !is.na(hdl), tchol - hdl, NA_real_),  
    
    ### Vitamin D categories
    vitD25oh_cat = case_when(
      is.na(vitD25oh)                  ~ NA_character_,
      vitD25oh < 20                    ~ "<20 (deficient)",
      vitD25oh >= 20 & vitD25oh < 30   ~ "20–29 (insufficient)",
      vitD25oh >= 30                   ~ "≥30 (sufficient)"
    ),
    vitD25oh_cat = factor(
      vitD25oh_cat,
      levels = c("<20 (deficient)",
                 "20–29 (insufficient)",
                 "≥30 (sufficient)"),
      ordered = TRUE
    ),
    
    ### DII quartiles
    dii_quart = ntile(dii, 4),
    dii_quart = factor(
      dii_quart,
      levels = c(1, 2, 3, 4),
      labels = c(
        "Q1 (most anti-inflammatory)",
        "Q2",
        "Q3",
        "Q4 (most pro-inflammatory)"
      ),
      ordered = TRUE
    ),
    
    ### Pregnancy status
    preg_flag = case_when(
      preg == "Yes, positive lab pregnancy test or self-reported pregnant at exam" ~ 1,
      preg %in% c("SP not pregnant at exam",
                  "The participant was not pregnant at exam") ~ 0,
      preg %in% c("Cannot ascertain if SP is pregnant at exam",
                  "Cannot ascertain if the participant is pregnant at exam") ~ NA_real_,
      TRUE ~ NA_real_
    ),
    preg_status = factor(
      case_when(
        preg_flag == 1 ~ "Pregnant",
        preg_flag == 0 ~ "Not pregnant",
        TRUE ~ NA_character_
      ),
      levels = c("Not pregnant", "Pregnant")
    ),
    
    ### Quartiles for DII component nutrients
    across(
      all_of(dii_component_vars),
      ~ ntile(., 4),
      .names = "{.col}_quart"
    ),
    across(
      all_of(paste0(dii_component_vars, "_quart")),
      ~ factor(
        .,
        levels = c(1, 2, 3, 4),
        labels = c("Q1", "Q2", "Q3", "Q4"),
        ordered = TRUE
      )
    ),
    
    ### BMI categories
    bmi_cat = case_when(
      is.na(bmi)       ~ NA_character_,
      bmi < 18.5       ~ "Underweight (<18.5)",
      bmi < 25         ~ "Normal (18.5–24.9)",
      bmi < 30         ~ "Overweight (25–29.9)",
      bmi < 35         ~ "Obesity I (30–34.9)",
      bmi < 40         ~ "Obesity II (35–39.9)",
      TRUE             ~ "Obesity III (≥40)"
    ),
    bmi_cat = factor(
      bmi_cat,
      levels = c(
        "Underweight (<18.5)",
        "Normal (18.5–24.9)",
        "Overweight (25–29.9)",
        "Obesity I (30–34.9)",
        "Obesity II (35–39.9)",
        "Obesity III (≥40)"
      ),
      ordered = TRUE
    ),
    
    ### Waist-to-height ratio categories
    whtr_cat = case_when(
      is.na(whtr)      ~ NA_character_,
      whtr < 0.5       ~ "<0.5",
      whtr < 0.6       ~ "0.5–0.59",
      TRUE             ~ "≥0.6"
    ),
    whtr_cat = factor(
      whtr_cat,
      levels = c("<0.5", "0.5–0.59", "≥0.6"),
      ordered = TRUE
    ),
    
    ### SBP categories
    sbp_cat = case_when(
      is.na(sbp_mean)  ~ NA_character_,
      sbp_mean < 120   ~ "<120",
      sbp_mean < 130   ~ "120–129",
      sbp_mean < 140   ~ "130–139",
      sbp_mean < 160   ~ "140–159",
      TRUE             ~ "≥160"
    ),
    sbp_cat = factor(
      sbp_cat,
      levels = c("<120", "120–129", "130–139", "140–159", "≥160"),
      ordered = TRUE
    ),
    
    ### DBP categories
    dbp_cat = case_when(
      is.na(dbp_mean)  ~ NA_character_,
      dbp_mean < 80    ~ "<80",
      dbp_mean < 90    ~ "80–89",
      dbp_mean < 100   ~ "90–99",
      TRUE             ~ "≥100"
    ),
    dbp_cat = factor(
      dbp_cat,
      levels = c("<80", "80–89", "90–99", "≥100"),
      ordered = TRUE
    ),
    
    ### Numeric variables for ordered categories (for trend tests)
    dii_quart_trend    = if_else(!is.na(dii_quart),    as.numeric(dii_quart)    - 1, NA_real_),
    food_sec_score     = if_else(!is.na(food_sec),     as.numeric(food_sec)     - 1, NA_real_),
    vitD25oh_cat_trend = if_else(!is.na(vitD25oh_cat), as.numeric(vitD25oh_cat) - 1, NA_real_),
    bmi_cat_trend      = if_else(!is.na(bmi_cat),      as.numeric(bmi_cat)      - 1, NA_real_),
    whtr_cat_trend     = if_else(!is.na(whtr_cat),     as.numeric(whtr_cat)     - 1, NA_real_),
    sbp_cat_trend      = if_else(!is.na(sbp_cat),      as.numeric(sbp_cat)      - 1, NA_real_),
    dbp_cat_trend      = if_else(!is.na(dbp_cat),      as.numeric(dbp_cat)      - 1, NA_real_),
    phys_act_trend     = if_else(!is.na(phys_act),     as.numeric(phys_act)     - 1, NA_real_)
  )


# Finalize analytic dataset for regression and machine learning -------------------------------
## Construct final analytic dataset with all needed variables
nhanes_analytic <- nhanes_analytic |>
  select(
    ### IDs and survey design
    seqn,
    sddsrvyr, cycle_str, sdmvpsu, sdmvstra,
    wtint2yr, wtmec2yr, wtint8yr, wtmec8yr,
    
    ### Demographics 
    age,          # Age
    sex,          # Sex (Male/Female)
    race,         # Race/ethnicity (5 categories)
    educ,         # Education (<9, 9–12, >12 years)
    pir,          # Poverty-income ratio
    
    ### Psychosocial and behavioral factors
    smoking,         # Smoking status (Never/Former/Current)
    phys_act,        # Physical activity (Sedentary/Moderate/Intense)
    phys_act_trend,  # Physical activity trend (0–2)
    food_sec,        # Food security (Full/Marginal/Low/Very low)
    food_sec_score,  # Food security score (0–3)
    insur,           # Health insurance (Yes/No)
    any_alcohol,     # Self-reported alcohol use (0/1; from ALQ101)
    alcohol,         # Self-reported alcohol use (No/Yes factor)
    
    ### Anthropometrics and cardiometabolic variables
    bmi,          # Body mass index (kg/m^2)  
    whtr,         # Waist-to-height ratio      
    sbp_mean,     # Mean systolic BP (mmHg)    
    dbp_mean,     # Mean diastolic BP (mmHg)   
    tchol,        # Total cholesterol (mg/dL)
    hdl,          # HDL cholesterol (mg/dL)
    non_hdl,      # Non-HDL cholesterol (mg/dL)
    hba1c,        # HbA1c (%)
    
    ### Anthropometric and BP categories 
    bmi_cat,
    bmi_cat_trend,  # BMI category trend (0–5)
    whtr_cat,
    whtr_cat_trend, # WHtR category trend (0–2)
    sbp_cat,
    sbp_cat_trend,  # SBP category trend (0–4)
    dbp_cat,
    dbp_cat_trend,  # DBP category trend (0–3)
    
    ### Vitamin D and DII summary scores
    vitD25oh,             # Serum Vitamin D [25(OH)D] (nmol/L)
    vitD25oh_cat,         # Vitamin D categories
    vitD25oh_cat_trend,   # Vitamin D category trend (0–2)
    dii,                  # DII (no alcohol)
    dii_quart,            # DII quartiles (ordered)
    dii_quart_trend,      # DII quartile trend (0–3)
    dii_etoh,             # DII including alcohol (secondary)
    
    ### DII component nutrient quartiles 
    kcal_quart, carb_quart, protein_quart, totalfat_quart, satfat_quart,
    pufa_quart, mufa_quart, n3fat_quart, n6fat_quart, choles_quart,
    vitA_quart, bcarotene_quart, vitC_quart, vitE_quart,
    vitB6_quart, vitB12_quart, folicacid_quart, thiamin_quart,
    riboflavin_quart, niacin_quart, iron_quart, mg_quart, zn_quart, se_quart,
    fiber_quart, caffeine_quart,
    
    ### Disease outcomes and family history
    asthma,       # Asthma
    ar,           # Allergic rhinitis
    arthritis,    # Inflammatory arthritis
    diabetes,     # Diabetes 
    htn,          # Hypertension
    ad,           # Eczema (2005–06)
    fa,           # Food allergy (2007–10)
    fh_asthma     # Family history of asthma
  )

## Set reference levels for key categorical variables in regression models
nhanes_analytic <- nhanes_analytic |>
  mutate(
    race         = fct_relevel(as.factor(race),         "Non-Hispanic White"),
    educ         = fct_relevel(as.factor(educ),         ">12 years"),
    vitD25oh_cat = fct_relevel(as.factor(vitD25oh_cat), "≥30 (sufficient)"),
    dii_quart    = fct_relevel(as.factor(dii_quart),    "Q1 (most anti-inflammatory)"),
    bmi_cat      = fct_relevel(as.factor(bmi_cat),      "Normal (18.5–24.9)")
  )

## Save analytic dataset for later use
saveRDS(nhanes_analytic, file = "nhanes_analytic.rds")

## Add a constant for total population estimates
nhanes_analytic <- nhanes_analytic |> mutate(one = 1)

## Configure survey options for lonely PSUs
options(survey.lonely.psu = "adjust")

## Define interview-weighted survey design (8-year pooled weights)
des_int_8yr <- svydesign(
  ids     = ~sdmvpsu,
  strata  = ~sdmvstra,
  weights = ~wtint8yr,
  nest    = TRUE,
  data    = nhanes_analytic
)

## Define MEC-weighted survey design (8-year pooled weights)
des_mec_8yr <- svydesign(
  ids     = ~sdmvpsu,
  strata  = ~sdmvstra,
  weights = ~wtmec8yr,
  nest    = TRUE,
  data    = nhanes_analytic
)

## Total weighted population using MEC weights
total_pop_mec_8yr <- svytotal(~one, design = des_mec_8yr)

# Regression dataset generation ---------------------------------------------------------------
## Set survey and contrast options for regression models
options(survey.lonely.psu = "adjust")
options(contrasts = c("contr.treatment", "contr.treatment"))

## Ensure presence of constant variable for total population estimates
if (!"one" %in% names(nhanes_analytic)) {
  nhanes_analytic <- nhanes_analytic |>
    mutate(one = 1)
}

## Construct outcome-specific analytic datasets restricted to non-missing outcomes
### Asthma non-missing
asthma_reg <- nhanes_analytic |>
  filter(!is.na(asthma))

### Allergic rhinitis non-missing
ar_reg <- nhanes_analytic |>
  filter(!is.na(ar))

### Inflammatory arthritis non-missing
inflam_reg <- nhanes_analytic |>
  filter(!is.na(arthritis))

### Hypertension non-missing
htn_reg <- nhanes_analytic |>
  filter(!is.na(htn))

### Diabetes non-missing
dm_reg <- nhanes_analytic |>
  filter(!is.na(diabetes))

### Eczema non-missing
ad_reg <- nhanes_analytic |>
  filter(sddsrvyr == 4, !is.na(ad))

### Food allergy non-missing
fa_reg <- nhanes_analytic |>
  filter(sddsrvyr %in% c(5, 6), !is.na(fa))

## Define helper function to construct outcome-specific survey designs using 8-year MEC weights
make_design_wt8yr <- function(data) {
  svydesign(
    ids     = ~sdmvpsu,
    strata  = ~sdmvstra,
    weights = ~wtmec8yr,
    nest    = TRUE,
    data    = data
  ) |>
    subset(wtmec8yr > 0)
}

## Construct outcome-specific survey designs for regression analyses
des_asthma_reg <- make_design_wt8yr(asthma_reg)
des_ar_reg     <- make_design_wt8yr(ar_reg)
des_inflam_reg <- make_design_wt8yr(inflam_reg)
des_htn_reg    <- make_design_wt8yr(htn_reg)
des_dm_reg     <- make_design_wt8yr(dm_reg)
des_ad_reg     <- make_design_wt8yr(ad_reg)
des_fa_reg     <- make_design_wt8yr(fa_reg)


## Define list structure to organize outcome-specific datasets and survey designs
outcome_designs <- list(
  asthma = list(
    var    = "asthma",
    label  = "Asthma",
    data   = asthma_reg,
    design = des_asthma_reg
  ),
  ar = list(
    var    = "ar",
    label  = "Allergic rhinitis",
    data   = ar_reg,
    design = des_ar_reg
  ),
  inflam = list(
    var    = "arthritis",
    label  = "Inflammatory arthritis",
    data   = inflam_reg,
    design = des_inflam_reg
  ),
  htn = list(
    var    = "htn",
    label  = "Hypertension",
    data   = htn_reg,
    design = des_htn_reg
  ),
  dm = list(
    var    = "diabetes",
    label  = "Diabetes",
    data   = dm_reg,
    design = des_dm_reg
  ),
  ad = list(
    var    = "ad",
    label  = "Eczema",
    data   = ad_reg,
    design = des_ad_reg
  ),
  fa = list(
    var    = "fa",
    label  = "Food allergy",
    data   = fa_reg,
    design = des_fa_reg
  )
)

# Variable information summary-----------------------------------------------------------------
## Full variable labels
var_labels <- c(
  ### IDs / survey design
  seqn      = "Participant ID",
  sddsrvyr  = "Survey cycle",
  cycle_str = "Survey cycle label",
  sdmvpsu   = "Masked variance pseudo-PSU",
  sdmvstra  = "Masked variance pseudo-stratum",
  wtint2yr  = "Interview weight (2-year)",
  wtmec2yr  = "MEC exam weight (2-year)",
  wtint8yr  = "Interview weight (8-year pooled)",
  wtmec8yr  = "MEC exam weight (8-year pooled)",
  
  ### Demographics
  age   = "Age in years",
  sex   = "Sex",
  race  = "Race/ethnicity",
  educ  = "Education level",
  pir   = "Poverty-income ratio",
  
  ### Behavioral
  smoking         = "Smoking status",
  phys_act        = "Recreational physical activity level",
  phys_act_trend  = "Physical activity trend score",
  food_sec        = "Household food security status",
  food_sec_score  = "Food security ordinal score",
  insur           = "Any health insurance coverage",
  any_alcohol     = "Ever drank ≥12 drinks in any 1 year (ALQ101)",
  alcohol         = "Alcohol use",
  
  ### Anthropometric and cardiometabolic
  bmi       = "Body mass index (kg/m^2)",
  whtr      = "Waist-to-height ratio",
  sbp_mean  = "Mean systolic blood pressure (mmHg)",
  dbp_mean  = "Mean diastolic blood pressure (mmHg)",
  tchol     = "Total cholesterol (mg/dL)",
  hdl       = "HDL cholesterol (mg/dL)",
  non_hdl   = "Non-HDL cholesterol (mg/dL)",
  hba1c     = "Hemoglobin A1c (%)",
  bmi_cat   = "BMI category",
  bmi_cat_trend  = "BMI category trend score",
  whtr_cat       = "Waist-to-height ratio category",
  whtr_cat_trend = "WHtR category trend score",
  sbp_cat        = "Systolic blood pressure category",
  sbp_cat_trend  = "SBP category trend score",
  dbp_cat        = "Diastolic blood pressure category",
  dbp_cat_trend  = "DBP category trend score",
  
  ### Nutrient (vitamin D and DII)
  vitD25oh           = "Serum Vitamin D [25(OH)D] concentration (nmol/L)",
  vitD25oh_cat       = "Vitamin D status category",
  vitD25oh_cat_trend = "Vitamin D status trend score",
  dii                = "Dietary Inflammatory Index (no alcohol)",
  dii_quart          = "DII quartile",
  dii_quart_trend    = "DII quartile trend score",
  dii_etoh           = "Dietary Inflammatory Index including alcohol",
  
  ### DII individual nutrient quartiles
  kcal_quart      = "Total energy intake (kcal) quartile",
  carb_quart      = "Carbohydrate intake quartile",
  protein_quart   = "Protein intake quartile",
  totalfat_quart  = "Total fat intake quartile",
  satfat_quart    = "Saturated fat intake quartile",
  pufa_quart      = "Polyunsaturated fat intake quartile",
  mufa_quart      = "Monounsaturated fat intake quartile",
  n3fat_quart     = "Omega-3 fat intake quartile",
  n6fat_quart     = "Omega-6 fat intake quartile",
  choles_quart    = "Cholesterol intake quartile",
  vitA_quart      = "Vitamin A intake quartile",
  bcarotene_quart = "Beta-carotene intake quartile",
  vitC_quart      = "Vitamin C intake quartile",
  vitE_quart      = "Vitamin E intake quartile",
  vitB6_quart     = "Vitamin B6 intake quartile",
  vitB12_quart    = "Vitamin B12 intake quartile",
  folicacid_quart = "Folic acid intake quartile",
  thiamin_quart   = "Thiamin intake quartile",
  riboflavin_quart = "Riboflavin intake quartile",
  niacin_quart    = "Niacin intake quartile",
  iron_quart      = "Iron intake quartile",
  mg_quart        = "Magnesium intake quartile",
  zn_quart        = "Zinc intake quartile",
  se_quart        = "Selenium intake quartile",
  fiber_quart     = "Fiber intake quartile",
  caffeine_quart  = "Caffeine intake quartile",
  
  ### Outcomes and related variables
  asthma    = "Reported asthma",
  ar        = "Reported allergic rhinitis (hay fever)",
  arthritis = "Reported rheumatoid or psoriatic arthritis",
  diabetes  = "Reported diabetes",
  htn       = "Reported hypertension",
  ad        = "Reported eczema (atopic dermatitis; 2005–2006 only)",
  fa        = "Reported food allergy",
  fh_asthma = "Family history of asthma"
)

## Define variable categories
var_roles <- c(
  ### ID and design
  seqn      = "id",
  sddsrvyr  = "design",
  cycle_str = "design",
  sdmvpsu   = "design",
  sdmvstra  = "design",
  wtint2yr  = "weight_2yr",
  wtmec2yr  = "weight_2yr",
  wtint8yr  = "weight_8yr",
  wtmec8yr  = "weight_8yr",
  
  ### Core predictors
  age   = "predictor_core",
  sex   = "predictor_core",
  race  = "predictor_core",
  educ  = "predictor_core",
  pir   = "predictor_core",
  
  smoking         = "predictor_core",
  phys_act        = "predictor_core",
  phys_act_trend  = "predictor_core",
  food_sec        = "predictor_core",
  food_sec_score  = "predictor_core",
  insur           = "predictor_core",
  any_alcohol     = "predictor_core",
  alcohol         = "predictor_core",
  
  bmi       = "predictor_core",
  whtr      = "predictor_core",
  sbp_mean  = "predictor_core",
  dbp_mean  = "predictor_core",
  tchol     = "predictor_core",
  hdl       = "predictor_core",
  non_hdl   = "predictor_core",
  hba1c     = "predictor_core",
  bmi_cat   = "predictor_core",
  bmi_cat_trend  = "predictor_core",
  whtr_cat       = "predictor_core",
  whtr_cat_trend = "predictor_core",
  sbp_cat        = "predictor_core",
  sbp_cat_trend  = "predictor_core",
  dbp_cat        = "predictor_core",
  dbp_cat_trend  = "predictor_core",
  
  ### Vitamin D and DII
  vitD25oh           = "predictor_core",
  vitD25oh_cat       = "predictor_core",
  vitD25oh_cat_trend = "predictor_core",
  dii                = "exposure_DII_main",
  dii_quart          = "exposure_DII_ordinal",
  dii_quart_trend    = "exposure_DII_trend",
  dii_etoh           = "exposure_DII_secondary",
  
  ### Nutrient quartiles
  kcal_quart      = "predictor_nutrient",
  carb_quart      = "predictor_nutrient",
  protein_quart   = "predictor_nutrient",
  totalfat_quart  = "predictor_nutrient",
  satfat_quart    = "predictor_nutrient",
  pufa_quart      = "predictor_nutrient",
  mufa_quart      = "predictor_nutrient",
  n3fat_quart     = "predictor_nutrient",
  n6fat_quart     = "predictor_nutrient",
  choles_quart    = "predictor_nutrient",
  vitA_quart      = "predictor_nutrient",
  bcarotene_quart = "predictor_nutrient",
  vitC_quart      = "predictor_nutrient",
  vitE_quart      = "predictor_nutrient",
  vitB6_quart     = "predictor_nutrient",
  vitB12_quart    = "predictor_nutrient",
  folicacid_quart = "predictor_nutrient",
  thiamin_quart   = "predictor_nutrient",
  riboflavin_quart = "predictor_nutrient",
  niacin_quart    = "predictor_nutrient",
  iron_quart      = "predictor_nutrient",
  mg_quart        = "predictor_nutrient",
  zn_quart        = "predictor_nutrient",
  se_quart        = "predictor_nutrient",
  fiber_quart     = "predictor_nutrient",
  caffeine_quart  = "predictor_nutrient",
  
  ### Outcomes
  asthma    = "outcome_primary",
  ar        = "outcome_primary",
  arthritis = "outcome_primary",
  diabetes  = "outcome_primary",
  htn       = "outcome_primary",
  ad        = "outcome_secondary",
  fa        = "outcome_secondary",
  fh_asthma = "predictor_family_history"
)

## Helper function to generate variable summary for data dictionary table
make_var_summary <- function(data, vars = names(data),
                             var_labels = NULL) {
  map_dfr(vars, function(v) {
    x <- data[[v]]
    n <- length(x)
    n_missing <- sum(is.na(x))
    pct_missing <- if (n > 0) n_missing / n else NA_real_
    
    type <- if (is.factor(x)) {
      "factor"
    } else if (is.character(x)) {
      "character"
    } else if (is.numeric(x)) {
      "numeric"
    } else if (is.logical(x)) {
      "logical"
    } else {
      paste(class(x), collapse = ",")
    }
    
    if (is.numeric(x)) {
      rng <- suppressWarnings(range(x, na.rm = TRUE))
      min_val <- if (length(rng) == 2 && all(is.finite(rng))) rng[1] else NA_real_
      max_val <- if (length(rng) == 2 && all(is.finite(rng))) rng[2] else NA_real_
      levels_info <- NA_character_
    } else {
      min_val <- NA_real_
      max_val <- NA_real_
      
      if (is.factor(x)) {
        lv <- levels(x)
      } else {
        lv <- unique(x)
        lv <- lv[!is.na(lv)]
        lv <- as.character(lv)
      }
      
      lv <- head(lv, 20L)
      levels_info <- if (length(lv) == 0) NA_character_ else paste(lv, collapse = "; ")
    }
    
    label <- if (!is.null(var_labels) && !is.null(var_labels[[v]])) {
      var_labels[[v]]
    } else {
      v
    }
    
    tibble(
      variable    = v,
      label       = label,
      type        = type,
      n           = n,
      n_missing   = n_missing,
      pct_missing = pct_missing,
      min         = min_val,
      max         = max_val,
      levels      = levels_info
    )
  })
}

## Variables to include in data dictionary table
vars_for_dict <- c(
  # ID and design
  "seqn","sddsrvyr","cycle_str","sdmvpsu","sdmvstra",
  "wtint2yr","wtmec2yr","wtint8yr","wtmec8yr",
  
  # Demographics
  "age","sex","race","educ","pir",
  
  # Psychosocial
  "smoking","phys_act","phys_act_trend",
  "food_sec",
  "insur","alcohol",
  
  # Anthropometric and cardiometabolic
  "bmi","whtr","sbp_mean","dbp_mean",
  "tchol","hdl","non_hdl","hba1c",
  "bmi_cat","bmi_cat_trend",
  "whtr_cat","whtr_cat_trend",
  "sbp_cat","sbp_cat_trend",
  "dbp_cat","dbp_cat_trend",
  
  # Vitamin D and DII
  "vitD25oh","vitD25oh_cat","vitD25oh_cat_trend",
  "dii","dii_quart","dii_quart_trend",
  "dii_etoh",
  
  # Nutrient quartiles
  "kcal_quart","carb_quart","protein_quart","totalfat_quart","satfat_quart",
  "pufa_quart","mufa_quart","n3fat_quart","n6fat_quart","choles_quart",
  "vitA_quart","bcarotene_quart","vitC_quart","vitE_quart",
  "vitB6_quart","vitB12_quart","folicacid_quart","thiamin_quart",
  "riboflavin_quart","niacin_quart","iron_quart","mg_quart","zn_quart","se_quart",
  "fiber_quart","caffeine_quart",
  
  # Outcomes
  "asthma","ar","arthritis","diabetes","htn","ad","fa",
  "fh_asthma"
)

## Create variable summary for table
var_summary <- make_var_summary(
  data       = nhanes_analytic,
  vars       = vars_for_dict,
  var_labels = var_labels
)

## Grouping of variables for Table 1
table1_group_map <- c(
  seqn        = "Demographics",
  sddsrvyr    = "Demographics",
  cycle_str   = "Demographics",
  sdmvpsu     = "Demographics",
  sdmvstra    = "Demographics",
  wtint2yr    = "Demographics",
  wtmec2yr    = "Demographics",
  wtint8yr    = "Demographics",
  wtmec8yr    = "Demographics",
  age         = "Demographics",
  sex         = "Demographics",
  race        = "Demographics",
  educ        = "Demographics",
  pir         = "Demographics",
  smoking     = "Demographics",
  phys_act    = "Demographics",
  phys_act_trend = "Demographics",
  food_sec    = "Demographics",
  insur       = "Demographics",
  alcohol     = "Demographics",
  fh_asthma   = "Demographics",
  
  bmi             = "Anthropometrics",
  whtr            = "Anthropometrics",
  sbp_mean        = "Anthropometrics",
  dbp_mean        = "Anthropometrics",
  tchol           = "Anthropometrics",
  hdl             = "Anthropometrics",
  non_hdl         = "Anthropometrics",
  hba1c           = "Anthropometrics",
  bmi_cat         = "Anthropometrics",
  bmi_cat_trend   = "Anthropometrics",
  whtr_cat        = "Anthropometrics",
  whtr_cat_trend  = "Anthropometrics",
  sbp_cat         = "Anthropometrics",
  sbp_cat_trend   = "Anthropometrics",
  dbp_cat         = "Anthropometrics",
  dbp_cat_trend   = "Anthropometrics",
  
  vitD25oh           = "Nutrients",
  vitD25oh_cat       = "Nutrients",
  vitD25oh_cat_trend = "Nutrients",
  dii                = "Nutrients",
  dii_quart          = "Nutrients",
  dii_quart_trend    = "Nutrients",
  dii_etoh           = "Nutrients",
  kcal_quart         = "Nutrients",
  carb_quart         = "Nutrients",
  protein_quart      = "Nutrients",
  totalfat_quart     = "Nutrients",
  satfat_quart       = "Nutrients",
  pufa_quart         = "Nutrients",
  mufa_quart         = "Nutrients",
  n3fat_quart        = "Nutrients",
  n6fat_quart        = "Nutrients",
  choles_quart       = "Nutrients",
  vitA_quart         = "Nutrients",
  bcarotene_quart    = "Nutrients",
  vitC_quart         = "Nutrients",
  vitE_quart         = "Nutrients",
  vitB6_quart        = "Nutrients",
  vitB12_quart       = "Nutrients",
  folicacid_quart    = "Nutrients",
  thiamin_quart      = "Nutrients",
  riboflavin_quart   = "Nutrients",
  niacin_quart       = "Nutrients",
  iron_quart         = "Nutrients",
  mg_quart           = "Nutrients",
  zn_quart           = "Nutrients",
  se_quart           = "Nutrients",
  fiber_quart        = "Nutrients",
  caffeine_quart     = "Nutrients",
  
  asthma    = "Disease Outcomes",
  ar        = "Disease Outcomes",
  arthritis = "Disease Outcomes",
  diabetes  = "Disease Outcomes",
  htn       = "Disease Outcomes",
  ad        = "Disease Outcomes",
  fa        = "Disease Outcomes"
)

## Define helper function to identify binary numeric variables
identify_binary <- function(x) {
  vals <- unique(na.omit(x))
  length(vals) <= 2 && all(vals %in% c(0, 1))
}

## Prepare Table 1 (data dictionary table)
table1_df <- var_summary |>
  mutate(
    ### Binary 0/1 variable handling
    binary_flag = map_lgl(variable, ~ identify_binary(nhanes_analytic[[.x]])),
    Type = case_when(
      binary_flag ~ "binary",
      type == "numeric" ~ "numeric",
      TRUE ~ type
    ),
    N           = as.integer(n),
    N_missing   = as.integer(n_missing),
    group       = table1_group_map[variable]
  ) |>
  select(
    group,
    Variable    = variable,
    Content     = label,
    Type,
    N,
    N_missing,
    pct_missing,
    Min         = min,
    Max         = max,
    Levels      = levels,
    binary_flag
  ) |>
  mutate(
    Min    = if_else(binary_flag, 0, Min),
    Max    = if_else(binary_flag, 1, Max),
    Levels = if_else(binary_flag, "0=No; 1=Yes", Levels),
    ### Fine-tune levels of select ariables
    Levels = case_when(
      Variable == "sddsrvyr"     ~ "4=2005–06; 5=2007–08; 6=2009–10; 7=2011–12",
      Variable == "bmi_cat"      ~ "Underweight (<18.5); Normal (18.5–24.9); Overweight (25–29.9); Obesity I (30–34.9); Obesity II (35–39.9); Obesity III (≥40)",
      Variable == "vitD25oh_cat" ~ "<20 (deficient); 20–29 (insufficient); ≥30 (sufficient)",
      Variable == "educ"         ~ "<9 years; 9–12 years; >12 years",
      TRUE ~ Levels
    )
  ) |>
  arrange(
    factor(
      group,
      levels = c("Demographics", "Anthropometrics", "Nutrients", "Disease Outcomes")
    ),
    Variable
  ) |>
  select(
    group,
    Variable,
    Content,
    Type,
    N,
    `N missing` = N_missing,
    `% missing` = pct_missing,
    Min,
    Max,
    Levels
  )

## Generate Table 1
labs_vars <- c("bmi","whtr","tchol","hdl","non_hdl","hba1c","vitD25oh","dii","dii_etoh")

nhanes_table1_gt <- table1_df |>
  gt(groupname_col = "group") |>
  tab_header(
    title = md("**Table 1: Extracted Variables: Types, Distributions, and Missingness**")
  ) |>
  cols_label(
    N = md("N"),
    `N missing` = md("N missing"),
    `% missing` = md("% missing")
  ) |>
  ### % missing always with 3 decimals
  fmt_number(
    columns = `% missing`,
    decimals = 3
  ) |>
  ### Min/Max for selected continuous variables: 1 decimal
  fmt_number(
    columns = c(Min, Max),
    decimals = 1,
    rows = Variable %in% labs_vars & Type != "binary"
  ) |>
  ### Min/Max for all other non-binary numeric variables: 0 decimals
  fmt_number(
    columns = c(Min, Max),
    decimals = 0,
    rows = !(Variable %in% labs_vars) & Type != "binary"
  ) |>
  ### Min/Max for binary 0/1 variables: 0 decimals (0 and 1)
  fmt_number(
    columns = c(Min, Max),
    decimals = 0,
    rows = Type == "binary"
  ) |>
  ### Supress seqn separators
  fmt_number(
    columns = c(Min, Max),
    decimals = 0,
    use_seps = FALSE,
    rows = Variable == "seqn"
  ) |>
  cols_align(align = "left") |>
  tab_options(table.font.size = px(12)) |>
  ### Bold column headings and row group labels
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = list(
      cells_column_labels(everything()),
      cells_row_groups()
    )
  )

# Additional adjustments for regression analyses-----------------------------------------------
## Add trend variables to outcome-specific survey designs
add_trend_vars_to_design <- function(design) {
  vars <- design$variables

  if ("vitD25oh_cat" %in% names(vars) && !"vitD25oh_cat_trend" %in% names(vars)) {
    vars <- vars |>
      mutate(
        vitD25oh_cat_trend = if_else(
          !is.na(vitD25oh_cat),
          as.numeric(vitD25oh_cat) - 1,
          NA_real_
        )
      )
  }

  if ("dii_quart" %in% names(vars) && !"dii_quart_trend" %in% names(vars)) {
    vars <- vars |>
      mutate(
        dii_quart_trend = if_else(
          !is.na(dii_quart),
          as.numeric(dii_quart) - 1,
          NA_real_
        )
      )
  }

  design$variables <- vars
  design
}

des_asthma_reg  <- add_trend_vars_to_design(des_asthma_reg)
des_ar_reg      <- add_trend_vars_to_design(des_ar_reg)
des_inflam_reg  <- add_trend_vars_to_design(des_inflam_reg)
des_htn_reg     <- add_trend_vars_to_design(des_htn_reg)
des_dm_reg      <- add_trend_vars_to_design(des_dm_reg)
des_ad_reg      <- add_trend_vars_to_design(des_ad_reg)
des_fa_reg      <- add_trend_vars_to_design(des_fa_reg)

## Full cohort design for characteristics and prevalence
make_design_wt8yr <- function(data) {
  svydesign(
    ids     = ~sdmvpsu,
    strata  = ~sdmvstra,
    weights = ~wtmec8yr,
    nest    = TRUE,
    data    = data
  ) |>
    subset(wtmec8yr > 0)
}

des_full <- make_design_wt8yr(nhanes_analytic)

## Outcome lists
outcome_list <- list(
  asthma = list(
    var    = "asthma",
    design = des_asthma_reg,
    label  = "Asthma"
  ),
  ar = list(
    var    = "ar",
    design = des_ar_reg,
    label  = "Allergic rhinitis"
  ),
  inflam = list(
    var    = "arthritis",
    design = des_inflam_reg,
    label  = "Inflammatory arthritis"
  ),
  htn = list(
    var    = "htn",
    design = des_htn_reg,
    label  = "Hypertension"
  ),
  dm = list(
    var    = "diabetes",
    design = des_dm_reg,
    label  = "Diabetes"
  )
)

outcome_list_secondary <- list(
  ad = list(
    var    = "ad",
    design = des_ad_reg,
    label  = "Atopic dermatitis"
  ),
  fa = list(
    var    = "fa",
    design = des_fa_reg,
    label  = "Food allergy"
  )
)

## Labels for core covariates and DII-related predictors
uni1_labels <- c(
  age                 = "Age (years)",
  sex                 = "Sex",
  race                = "Race/ethnicity",
  insur               = "Insurance",
  educ                = "Education",
  pir                 = "Poverty-income ratio",
  food_sec            = "Food security",
  smoking             = "Smoking status",
  phys_act            = "Physical activity",
  alcohol             = "Alcohol use",
  sbp_cat             = "Systolic blood pressure category",
  dbp_cat             = "Diastolic blood pressure category",
  bmi_cat             = "BMI category",
  whtr_cat            = "Waist-to-height ratio category",
  hdl                 = "HDL cholesterol (mg/dL)",
  non_hdl             = "Non-HDL cholesterol (mg/dL)",
  tchol               = "Total cholesterol (mg/dL)",
  hba1c               = "HbA1c (%)",
  vitD25oh_cat        = "25(OH)D category",
  vitD25oh_cat_trend  = "25(OH)D category trend (0–2)",
  dii                 = "Dietary Inflammatory Index (per unit)",
  dii_quart_trend     = "DII quartile trend (0–3)",
  dii_etoh            = "DII including alcohol (per unit)"
)

## Mapping of factor levels to labels for characteristics and univariable models
custom_order_uni1 <- tribble(
  ~predictor, ~level,                                  ~variable_label,                                         ~rank,
  ### Sex
  "sex",      "Male",                                  "Sex: Male",                                            1,
  "sex",      "Female",                                "Sex: Female",                                          2,

  ### Race
  "race",     "Non-Hispanic White",                    "Race/ethnicity: Non-Hispanic White",                   1,
  "race",     "Non-Hispanic Black",                    "Race/ethnicity: Non-Hispanic Black",                   2,
  "race",     "Mexican American",                      "Race/ethnicity: Mexican American",                     3,
  "race",     "Other Hispanic",                        "Race/ethnicity: Other Hispanic",                       4,
  "race",     "Other/multiracial",                     "Race/ethnicity: Other race",                           5,

  ### Insurance
  "insur",    "No",                                    "Insurance: No",                                        1,
  "insur",    "Yes",                                   "Insurance: Yes",                                       2,

  ### Education
  "educ",     "<9 years",                              "Education: <9",                                        1,
  "educ",     "9–12 years",                            "Education: 9-12",                                      2,
  "educ",     ">12 years",                             "Education: >12",                                       3,

  ### Food security
  "food_sec", "Full",                                  "Food security: Full",                                  1,
  "food_sec", "Marginal",                              "Food security: Marginal",                              2,
  "food_sec", "Low",                                   "Food security: Low",                                   3,
  "food_sec", "Very low",                              "Food security: Very low",                              4,

  ### Smoking
  "smoking",  "Never",                                 "Smoking status: Never",                                1,
  "smoking",  "Current",                               "Smoking status: Current",                              2,
  "smoking",  "Former",                                "Smoking status: Former",                               3,

  ### Alcohol
  "alcohol",  "No",                                    "Alcohol use: No",                                      1,
  "alcohol",  "Yes",                                   "Alcohol use: Yes",                                     2,

  ### Physical activity
  "phys_act", "Sedentary",                             "Physical activity: Sedentary",                         1,
  "phys_act", "Moderate",                              "Physical activity: Moderate",                          2,
  "phys_act", "Intense",                               "Physical activity: Intense",                           3,

  ### SBP categories
  "sbp_cat",  "<120",                                  "Systolic blood pressure category: <120",               1,
  "sbp_cat",  "120–129",                               "Systolic blood pressure category: 120-129",            2,
  "sbp_cat",  "130–139",                               "Systolic blood pressure category: 130-139",            3,
  "sbp_cat",  "140–159",                               "Systolic blood pressure category: 140-159",           4,
  "sbp_cat",  "≥160",                                  "Systolic blood pressure category: >=160",              5,

  ### DBP categories
  "dbp_cat",  "<80",                                   "Diastolic blood pressure category: <80",               1,
  "dbp_cat",  "80–89",                                 "Diastolic blood pressure category: 80-89",             2,
  "dbp_cat",  "90–99",                                 "Diastolic blood pressure category: 90-99",             3,
  "dbp_cat",  "≥100",                                  "Diastolic blood pressure category: >=100",             4,

  ### BMI categories
  "bmi_cat",  "Underweight (<18.5)",                   "BMI category: Underweight",                            1,
  "bmi_cat",  "Normal (18.5–24.9)",                    "BMI category: Normal weight",                          2,
  "bmi_cat",  "Overweight (25–29.9)",                  "BMI category: Overweight",                             3,
  "bmi_cat",  "Obesity I (30–34.9)",                   "BMI category: Obesity I",                              4,
  "bmi_cat",  "Obesity II (35–39.9)",                  "BMI category: Obesity II",                             5,
  "bmi_cat",  "Obesity III (≥40)",                     "BMI category: Obesity III",                            6,

  ### WHtR categories
  "whtr_cat", "<0.5",                                  "Waist-to-height ratio category: <0.5",                 1,
  "whtr_cat", "0.5–0.59",                              "Waist-to-height ratio category: 0.5-0.59",             2,
  "whtr_cat", "≥0.6",                                  "Waist-to-height ratio category: >=0.6",                3,

  ### Vitamin D categories
  "vitD25oh_cat", "<20 (deficient)",                   "25(OH)D category: <20",                                1,
  "vitD25oh_cat", "20–29 (insufficient)",              "25(OH)D category: 20-29",                              2,
  "vitD25oh_cat", "≥30 (sufficient)",                  "25(OH)D category: >=30",                               3
)

is_poly_term <- function(terms, predictor) {
  any(grepl(paste0("^", predictor, "\\."), terms))
}

add_ref_and_label <- function(td, des, predictor, outcome_name, outcome_info, base_label = NULL) {
  if (is.null(base_label)) {
    base_label <- predictor
  }

  var_data <- des$variables[[predictor]]

  ### Numeric predictors have no reference row, only single row with label
  if (is.numeric(var_data) || is.integer(var_data)) {
    td <- td |>
      mutate(variable_label = base_label)
    return(td)
  }

  ### Character predictors converted to factor
  if (is.character(var_data)) {
    var_data <- factor(var_data)
  }

  ### Detect polynomial terms and assign linear or quadratic trend
  if (is_poly_term(td$term, predictor)) {
    td <- td |>
      mutate(
        variable_label = case_when(
          grepl("\\.L$", term) ~ paste0(base_label, ": linear trend"),
          grepl("\\.Q$", term) ~ paste0(base_label, ": quadratic trend"),
          TRUE                 ~ paste0(base_label, ": ", term)
        )
      )
    return(td)
  }

  ### Add reference row and level labels for factor predictors
  if (is.factor(var_data)) {
    levels_vec <- levels(var_data)
    pattern    <- paste0("^", predictor)

    td_nonref <- td |>
      mutate(
        level          = sub(pattern, "", term),
        variable_label = paste0(base_label, ": ", level)
      )

    ref_level <- levels_vec[1]
    ref_label <- paste0(base_label, ": ", ref_level)

    ref_row <- tibble(
      term           = paste0(predictor, ref_level),
      estimate       = 1,
      conf.low       = 1,
      conf.high      = 1,
      p.value        = NA_real_,
      outcome        = outcome_name,
      outcome_lab    = outcome_info$label,
      predictor      = predictor,
      level          = ref_level,
      variable_label = ref_label
    )

    td_full <- bind_rows(ref_row, td_nonref)
    return(td_full)
  }
  td |>
    mutate(variable_label = base_label)
}

# Print Table 1 variable summary---------------------------------------------------------------
nhanes_table1_gt
```

## Results {#sec-results}

**Cohort characteristics**

Cohort characteristics are shown in **Table 2** for the full cohort (2005–2012) and in **Table 3** for the time-restricted cohorts for eczema (2005–2006) and food allergy (2007–2010). In general, participants with asthma, allergic rhinitis, eczema, and food allergy were similar to the respective full cohort populations, with modest differences (e.g., higher proportions of males and small variations in physical activity and smoking patterns). Patients with allergic rhinitis, inflammatory arthritis, diabetes, and hypertension were slightly older than the full cohort. Those with inflammatory arthritis, diabetes, and hypertension also exhibited higher DII scores, while participants with allergic rhinitis had slightly lower DII scores relative to the full cohort. There were smaller differences in DII scores in the eczema and food allergy cohorts relative to their respective time-restricted full cohorts. These differences were formally assessed in subsequent regression analyses.

```{r}
# Continuous covariates and categorical levels ------------------------------------------------
## Continuous characteristics
char_continuous <- c("age", "pir", "hdl", "non_hdl", "tchol", "hba1c", "dii", "dii_etoh")

## Predictor order 
char_order <- c(
  "age",
  "sex",
  "race",
  "insur",
  "educ",
  "pir",
  "food_sec",
  "smoking",
  "phys_act",
  "alcohol",
  "sbp_cat",
  "dbp_cat",
  "bmi_cat",
  "whtr_cat",
  "hdl",
  "non_hdl",
  "tchol",
  "hba1c",
  "vitD25oh_cat",
  "dii",
  "dii_etoh"
)

## Characteristics to include
char_skeleton_raw <- bind_rows(
  tibble(
    predictor      = char_continuous,
    level          = NA_character_,
    variable_label = uni1_labels[char_continuous],
    type           = "continuous",
    rank           = NA_integer_
  ),
  custom_order_uni1 |>
    mutate(type = "categorical")
)

## Characteristic ordering
char_skeleton <- char_skeleton_raw |>
  mutate(
    predictor = factor(
      predictor,
      levels = c(char_order, setdiff(unique(predictor), char_order))
    )
  ) |>
  arrange(predictor, rank) |>
  mutate(
    predictor = as.character(predictor)
  )

## Helper function to compute characteristics for a single survey design
compute_char_for_group <- function(design, group_name) {
  vars <- design$variables

  map_dfr(
    seq_len(nrow(char_skeleton)),
    function(i) {
      row       <- char_skeleton[i, ]
      predictor <- row$predictor
      label     <- row$variable_label
      type      <- row$type
      lvl       <- row$level

      # If predictor not present, return NA
      if (!predictor %in% names(vars)) {
        return(tibble(
          Group          = group_name,
          Characteristic = label,
          Value          = NA_character_
        ))
      }

      if (type == "continuous") {
        # Continuous: survey-weighted mean (SE)
        f   <- as.formula(paste0("~", predictor))
        est <- svymean(f, design, na.rm = TRUE)
        m   <- as.numeric(est)[1]
        se  <- as.numeric(SE(est))[1]
        value <- sprintf("%.2f (%.2f)", m, se)

      } else {
        ### Categorical: survey-weighted prevalence (SE) for each level
        var <- vars[[predictor]]

        ### Coerce to factor and drop unused levels
        if (!is.factor(var)) {
          var <- factor(var)
        } else {
          var <- droplevels(var)
        }

        ### If target level is missing or not in factor levels, return NA
        if (is.na(lvl) || !lvl %in% levels(var)) {
          return(tibble(
            Group          = group_name,
            Characteristic = label,
            Value          = NA_character_
          ))
        }

        ### Restrict to non-missing values for predictor
        nonmiss <- !is.na(var)
        if (!any(nonmiss)) {
          return(tibble(
            Group          = group_name,
            Characteristic = label,
            Value          = NA_character_
          ))
        }

        ### Subset design to non-missing rows for predictor
        design_nm <- subset(design, nonmiss)

        ### Compute vars for subsetted design and attach indicator
        vars_nm <- design_nm$variables
        vars_nm$indicator <- as.numeric(var[nonmiss] == lvl)
        design_nm$variables <- vars_nm

        est <- tryCatch(
          svymean(~indicator, design_nm, na.rm = TRUE),
          error = function(e) NA
        )

        if (all(is.na(est))) {
          value <- NA_character_
        } else {
          p  <- as.numeric(est)[1] * 100
          se <- as.numeric(SE(est))[1] * 100
          value <- sprintf("%.1f%% (%.1f)", p, se)
        }
      }

      tibble(
        Group          = group_name,
        Characteristic = label,
        Value          = value
      )
    }
  )
}

# Full cohort and primary outcomes-------------------------------------------------------------
des_full_primary <- des_full

des_asthma_cases  <- subset(des_asthma_reg,  asthma == 1)
des_ar_cases      <- subset(des_ar_reg,      ar == 1)
des_inflam_cases  <- subset(des_inflam_reg,  arthritis == 1)
des_dm_cases      <- subset(des_dm_reg,      diabetes == 1)
des_htn_cases     <- subset(des_htn_reg,     htn == 1)

group_designs_primary <- list(
  "Full cohort"             = des_full_primary,
  "Asthma"                  = des_asthma_cases,
  "Allergic rhinitis"       = des_ar_cases,
  "Inflammatory arthritis"  = des_inflam_cases,
  "Diabetes"                = des_dm_cases,
  "Hypertension"            = des_htn_cases
)

## Unweighted Ns for primary groups
group_ns_primary <- map_int(group_designs_primary, ~ nrow(.x$variables))
group_labels_primary <- setNames(
  paste0(names(group_designs_primary), " (N=", group_ns_primary, ")"),
  names(group_designs_primary)
)

char_primary_long <- imap_dfr(
  group_designs_primary,
  ~ compute_char_for_group(design = .x, group_name = .y)
)

## Rename characteristics for DII and Vitamin D
char_primary_wide <- char_primary_long |>
  mutate(
    Characteristic = dplyr::recode(
      Characteristic,
      "Dietary Inflammatory Index (per unit)" = "Dietary Inflammatory Index (DII)",
      "DII including alcohol (per unit)"      = "DII including alcohol"
    ),
    Characteristic = gsub(
      "25\\(OH\\)D category",
      "Vitamin D category",
      Characteristic
    )
  ) |>
  pivot_wider(
    id_cols     = Characteristic,
    names_from  = Group,
    values_from = Value
  ) |>
  ### Add unweighted N to column labels
  rename_with(
    ~ group_labels_primary[.x],
    .cols = any_of(names(group_labels_primary))
  )

tbl_char_primary <- char_primary_wide |>
  gt() |>
  tab_header(
    title = md(
      "**Table 2: Characteristics of Full Cohort (2005–2012) and Participants with Asthma, Allergic Rhinitis, Inflammatory Arthritis, Diabetes, and Hypertension**"
    )
  ) |>
  fmt_markdown(columns = everything()) |>
  tab_options(
    table.font.size = px(10),
    column_labels.font.weight = "bold"
  ) |>
  tab_footnote(
    footnote = "For each characteristic, survey-weighted means (SE) are shown for continuous variables, and percentages of total within that category are shown for categorical variables.",
    locations = cells_title(groups = "title")
  )

# Time-restricted eczema and food allergy cohorts----------------------------------------------
ad_cohort <- nhanes_analytic |>
  filter(sddsrvyr == 4, !is.na(ad))

fa_cohort <- nhanes_analytic |>
  filter(sddsrvyr %in% c(5, 6), !is.na(fa))

des_ad_cohort <- make_design_wt8yr(ad_cohort)
des_fa_cohort <- make_design_wt8yr(fa_cohort)

des_ad_cases <- subset(des_ad_reg, ad == 1)
des_fa_cases <- subset(des_fa_reg, fa == 1)

group_designs_secondary <- list(
  "Cohort (2005–2006)"   = des_ad_cohort,
  "Eczema"               = des_ad_cases,
  "Cohort (2007–2010)"   = des_fa_cohort,
  "Food allergy"         = des_fa_cases
)

## Unweighted Ns for secondary groups
group_ns_secondary <- map_int(group_designs_secondary, ~ nrow(.x$variables))
group_labels_secondary <- setNames(
  paste0(names(group_designs_secondary), " (N=", group_ns_secondary, ")"),
  names(group_designs_secondary)
)

char_secondary_long <- imap_dfr(
  group_designs_secondary,
  ~ compute_char_for_group(design = .x, group_name = .y)
)

## Rename characteristics for DII and Vitamin D
char_secondary_wide <- char_secondary_long |>
  mutate(
    Characteristic = dplyr::recode(
      Characteristic,
      "Dietary Inflammatory Index (per unit)" = "Dietary Inflammatory Index (DII)",
      "DII including alcohol (per unit)"      = "DII including alcohol"
    ),
    Characteristic = gsub(
      "25\\(OH\\)D category",
      "Vitamin D category",
      Characteristic
    )
  ) |>
  pivot_wider(
    id_cols     = Characteristic,
    names_from  = Group,
    values_from = Value
  ) |>
  ### Add unweighted N to column labels
  rename_with(
    ~ group_labels_secondary[.x],
    .cols = any_of(names(group_labels_secondary))
  )

tbl_char_secondary <- char_secondary_wide |>
  gt() |>
  tab_header(
    title = md(
      "**Table 3: Characteristics of Time-Restricted Subcohorts and Participants with Eczema (2005–2006) and Food Allergy (2007–2010)**"
    )
  ) |>
  fmt_markdown(columns = everything()) |>
  tab_options(
    table.font.size = px(10),
    column_labels.font.weight = "bold"
  ) |>
  tab_footnote(
    footnote = "For each characteristic, survey-weighted means (SE) are shown for continuous variables, and percentages of total within that category are shown for categorical variables.",
    locations = cells_title(groups = "title")
  )

# Print cohort characteristic tables-----------------------------------------------------------
tbl_char_primary
tbl_char_secondary
```

**Weighted prevalence analysis**

Survey-weighted prevalence estimates were calculated for all disease outcomes, both overall and across DII quartiles (**Table 4**; **Figure 1**). Overall disease prevalence ranged from 1.3% for inflammatory arthritis to 15.9% for asthma. As compared with the weighted prevalence in the least inflammatory quartile (Q1), the weighted prevalence in the most inflammatory quartile (Q4) was significantly higher for inflammatory arthritis (2.1% vs. 0.8%; p\<0.05) and significantly lower for allergic rhinitis (11.5% vs. 14.1%; p\<0.05). There was a non-significant trend of higher Q4 disease prevalence for eczema and hypertension. Together, this suggested variable, modest effects of dietary inflammatory content on disease outcomes.

```{r}
# Weighted prevalence by DII quartile----------------------------------------------------------
## Outcome configurations for prevalence
outcome_list_all <- c(outcome_list, outcome_list_secondary)

compute_prev_by_dii <- function(info) {
  des       <- info$design
  y         <- info$var
  label_raw <- info$label

  ### Re-label atopic dermatitis to eczema
  label <- recode(label_raw, "Atopic dermatitis" = "Eczema")

  f    <- as.formula(paste0("~", y))
  vars <- des$variables

  rows <- list()

  ### Overall prevalence
  est_overall <- svymean(f, design = des, na.rm = TRUE)
  p_overall   <- as.numeric(est_overall)[1] * 100
  se_overall  <- as.numeric(SE(est_overall))[1] * 100

  rows[[length(rows) + 1]] <- tibble(
    Outcome   = label,
    dii_group = "Overall",
    prev_pct  = p_overall,
    prev_se   = se_overall
  )

  ### Prevalence by DII quartile
  if ("dii_quart" %in% names(vars)) {
    dii_levels <- levels(vars$dii_quart)
    for (lvl in dii_levels) {
      des_sub <- subset(des, dii_quart == lvl)
      est     <- svymean(f, design = des_sub, na.rm = TRUE)
      p       <- as.numeric(est)[1] * 100
      se      <- as.numeric(SE(est))[1] * 100

      rows[[length(rows) + 1]] <- tibble(
        Outcome   = label,
        dii_group = as.character(lvl),
        prev_pct  = p,
        prev_se   = se
      )
    }
  }

  if (length(rows) == 0L) {
    return(tibble(
      Outcome   = character(0),
      dii_group = character(0),
      prev_pct  = numeric(0),
      prev_se   = numeric(0)
    ))
  }

  bind_rows(rows)
}

prev_all_long <- map_dfr(
  outcome_list_all,
  compute_prev_by_dii
)

## Harmonize DII group labels and ordering of outcomes
prev_all_long <- prev_all_long |>
  mutate(
    dii_group_simple = case_when(
      dii_group == "Overall"        ~ "Overall",
      grepl("^Q1", dii_group)       ~ "Q1",
      grepl("^Q2", dii_group)       ~ "Q2",
      grepl("^Q3", dii_group)       ~ "Q3",
      grepl("^Q4", dii_group)       ~ "Q4",
      TRUE                          ~ dii_group
    ),
    ### Set base outcome order
    Outcome = factor(
      Outcome,
      levels = c(
        "Asthma",
        "Allergic rhinitis",
        "Inflammatory arthritis",
        "Diabetes",
        "Hypertension",
        "Eczema",
        "Food allergy"
      )
    )
  )

## Compute p-values for Q2–Q4 vs. Q1 via survey-weighted logistic regression
compute_prev_pvals <- function(info) {
  des       <- info$design
  y         <- info$var
  label_raw <- info$label

  label <- recode(label_raw, "Atopic dermatitis" = "Eczema")

  vars <- des$variables
  if (!("dii_quart" %in% names(vars))) {
    return(tibble(
      Outcome          = character(0),
      dii_group_simple = character(0),
      p_vs_Q1          = numeric(0)
    ))
  }

  dq <- vars$dii_quart
  if (!is.factor(dq)) {
    dq <- factor(dq)
  }

  levels_dq <- levels(dq)
  if (length(levels_dq) < 2) {
    return(tibble(
      Outcome          = character(0),
      dii_group_simple = character(0),
      p_vs_Q1          = numeric(0)
    ))
  }

  other_levels <- levels_dq[-1]

  ### Fit survey-weighted logistic regression
  form <- as.formula(paste0(y, " ~ dii_quart"))

  fit <- tryCatch(
    svyglm(form, design = des, family = quasibinomial()),
    error = function(e) NULL
  )

  if (is.null(fit)) {
    return(tibble(
      Outcome          = character(0),
      dii_group_simple = character(0),
      p_vs_Q1          = numeric(0)
    ))
  }

  coefs <- summary(fit)$coef

  out_rows <- purrr::map_dfr(other_levels, function(lvl) {
    term <- paste0("dii_quart", lvl)

    if (!term %in% rownames(coefs)) {
      p_val <- NA_real_
    } else {
      p_val <- coefs[term, "Pr(>|t|)"]
    }

    quart_simple <- case_when(
      grepl("^Q1", lvl) ~ "Q1",
      grepl("^Q2", lvl) ~ "Q2",
      grepl("^Q3", lvl) ~ "Q3",
      grepl("^Q4", lvl) ~ "Q4",
      TRUE              ~ lvl
    )

    tibble(
      Outcome          = label,
      dii_group_simple = quart_simple,
      p_vs_Q1          = as.numeric(p_val)
    )
  })

  out_rows
}

prev_pvals <- purrr::map_dfr(
  outcome_list_all,
  compute_prev_pvals
)

## Join p-values to prevalence data
prev_all_long <- prev_all_long |>
  left_join(
    prev_pvals,
    by = c("Outcome", "dii_group_simple")
  )

## Color scheme for outcomes
disease_base_cols <- c(
  "Asthma"                 = "#5E3C99",
  "Allergic rhinitis"      = "#89CFF0",
  "Inflammatory arthritis" = "#009E73",
  "Diabetes"               = "#F0E442",
  "Hypertension"           = "#D55E00",
  "Eczema"                 = "#E78AC3",
  "Food allergy"           = "#4B2E0F"
)

## Alpha for quartiles; overall uses mid alpha
alpha_quart <- c(
  "Q1" = 0.4,
  "Q2" = 0.6,
  "Q3" = 0.8,
  "Q4" = 1.0
)
alpha_overall <- 0.7

prev_all_long <- prev_all_long |>
  mutate(
    base_col = disease_base_cols[as.character(Outcome)],
    fill_col = case_when(
      dii_group_simple == "Overall" ~ scales::alpha(base_col, alpha_overall), 
      TRUE                          ~ scales::alpha(base_col, alpha_quart[dii_group_simple])
    ),
    Outcome_pretty = forcats::fct_recode(
      Outcome,
      "Allergic\nrhinitis"      = "Allergic rhinitis",
      "Inflammatory\narthritis" = "Inflammatory arthritis"
    ),
    ### Explicit facet order
    Outcome_pretty = factor(
      Outcome_pretty,
      levels = c(
        "Asthma",
        "Allergic\nrhinitis",
        "Inflammatory\narthritis",
        "Eczema",
        "Food allergy",
        "Diabetes",
        "Hypertension"
      )
    ),
    x_pos = case_when(
      dii_group_simple == "Overall" ~ 1.0,
      dii_group_simple == "Q1"      ~ 2.5,
      dii_group_simple == "Q2"      ~ 3.5,
      dii_group_simple == "Q3"      ~ 4.5,
      dii_group_simple == "Q4"      ~ 5.5,
      TRUE                          ~ NA_real_
    )
  )

## Split data for quartiles vs. overall
prev_quart <- prev_all_long |>
  filter(dii_group_simple != "Overall")

prev_overall <- prev_all_long |>
  filter(dii_group_simple == "Overall")

# Weighted prevalence table--------------------------------------------------------------------
## Outcome ordering for table
prev_all_long <- prev_all_long |>
  mutate(
    Outcome = factor(
      Outcome,
      levels = c(
        "Asthma",
        "Allergic rhinitis",
        "Inflammatory arthritis",
        "Diabetes",
        "Hypertension",
        "Eczema",
        "Food allergy"
      )
    )
  )

table4_df <- prev_all_long |>
  mutate(
    Condition = case_when(
      dii_group_simple == "Overall" ~ "Overall",
      TRUE                          ~ dii_group
    )
  ) |>
  select(
    Outcome,
    Condition,
    `Weighted prevalence (%)` = prev_pct,
    `SE (%)`                  = prev_se,
    `p value`                 = p_vs_Q1
  ) |>
  arrange(Outcome, Condition)

nhanes_table4_gt <- table4_df |>
  gt(groupname_col = "Outcome") |>
  tab_header(
    title = md("**Table 4: Weighted Prevalence of Allergic, Immunologic, and Cardiometabolic Conditions Overall and by Dietary Inflammatory Index Quartile**")
  ) |>
  fmt_number(
    columns = c(`Weighted prevalence (%)`, `SE (%)`),
    decimals = 1
  ) |>
  fmt_number(
    columns = `p value`,
    decimals = 3
  ) |>
  cols_label(
    Condition                 = md("Condition"),
    `Weighted prevalence (%)` = md("Weighted prevalence (%)"),
    `SE (%)`                  = md("SE (%)"),
    `p value`                 = md("p value")
  ) |>
  tab_source_note(
    md(
      "P values were obtained in survey-weighted logistic regression models of each outcome on DII quartile, comparing Q2 to Q4 with Q1 using Wald tests."
    )
  ) |>
  tab_options(
    table.font.size       = px(12),
    data_row.padding      = px(1),
    row_group.padding     = px(1),
    column_labels.padding = px(1),
    table.width           = pct(80)
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(everything()),
      cells_row_groups()
    )
  )

# Weighted prevalence plot---------------------------------------------------------------------
weighted_prev_plot_all <- ggplot() +
  ## Quartile bars
  geom_col(
    data = prev_quart,
    aes(
      x    = x_pos,
      y    = prev_pct,
      fill = fill_col
    ),
    width = 0.9
  ) +
  ## Overall bars
  geom_col(
    data = prev_overall,
    aes(
      x     = x_pos,
      y     = prev_pct,
      fill  = fill_col,
      color = base_col
    ),
    width = 0.9,
    size  = 0.9
  ) +
  facet_wrap(~ Outcome_pretty, ncol = 3, scales = "free_y") +
  scale_fill_identity(guide = "none") +
  scale_color_identity(guide = "none") +
  scale_x_continuous(
    breaks = c(1.0, 2.5, 3.5, 4.5, 5.5),
    labels = c("Overall", "Q1", "Q2", "Q3", "Q4"),
    expand = expansion(mult = c(0.05, 0.05))
  ) +
  labs(
    x     = NULL,
    y     = "Weighted prevalence (%)",
    title = "Figure 1: Weighted Prevalence of Allergic, Immunologic,\nCardiometabolic Conditions,\nOverall and by Dietary Inflammatory Index Quartile"
  ) +
  theme_minimal() +
  theme(
    plot.title         = element_text(face = "bold", size = 15, hjust = 0.5),
    strip.text         = element_text(face = "bold", size = 12),  # one size smaller
    axis.title.y       = element_text(face = "bold", size = 12),
    axis.title.x       = element_blank(),
    axis.text.x        = element_text(size = 11, angle = 45, hjust = 1),
    axis.text.y        = element_text(size = 11),
    aspect.ratio       = 1,
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey90"),
    panel.grid.minor.y = element_blank()
  )

# Print Table 4 and Figure 1-------------------------------------------------------------------
nhanes_table4_gt
weighted_prev_plot_all
```

**Univariable regression analyses**

Survey-weighted univariable logistic regression analyses were performed to examine associations between core sociodemographic, behavioral, clinical, and dietary covariates (**Tables 5–6**) or individual nutrient quartile covariates (**Tables 7–8**) and disease outcomes. Results for asthma, allergic rhinitis, inflammatory arthritis, diabetes, and hypertension are shown in **Table 5** and **Table 7**. Results for eczema and food allergy are shown in **Table 6** and **Table 8**.

Among the core covariates, the odds of allergic rhinitis increased with age (OR 1.06, 95% CI 1.05–1.08; p\<0.001), while asthma decreased with age (OR 0.97, 95% CI 0.96–0.99; p\<0.001). Female participants had higher odds of asthma (OR 1.35, 95% CI 1.17–1.56; p\<0.001), allergic rhinitis (OR 1.39, 95% CI 1.19–1.61; p\<0.001), and inflammatory arthritis (OR 2.31, 95% CI 1.53–3.49; p\<0.001). Non-Hispanic Black (OR 0.62, 95% CI 0.50–0.78; p\<0.001) and Mexican American (OR 0.35, 95% CI 0.27–0.45; p\<0.001) participants had lower odds of allergic rhinitis, and Mexican American participants (OR 0.42, 95% CI 0.32–0.55; p\<0.001) also had lower odds of asthma. Smoking was associated with increased odds of inflammatory arthritis (OR 2.64, 95% CI 1.63–4.27; p\<0.001). Among secondary outcomes, there was a trend of higher odds of eczema associated with obesity class III (OR 2.22, 95% CI 1.24–3.97; p=0.088). Mexican American participants had lower odds of food allergy (OR 0.62, 95% CI 0.48–0.81; p=0.013). Cardiometabolic outcomes were strongly associated with age and adiposity, for example increased odds of hypertension with age (OR 1.09, 95% CI 1.07–1.10; p\<0.001), obesity class III (OR 7.04, 95% CI 5.26–9.41; p\<0.001), and waist-to-height ratio ≥0.6 (OR 4.87, 95% CI 3.89–6.10; p\<0.001).

Regarding dietary inflammatory exposures, DII inclusive of alcohol intake was significantly associated with lower odds of allergic rhinitis (OR 0.96, 95% CI 0.92–0.99; p=0.044) and higher odds of hypertension (OR 1.05, 95% CI 1.01–1.08; p=0.049). In general, DII associations did not achieve statistical significance.

In nutrient-specific analyses, there was a large degree of variability across conditions, and many associations did not achieve statistical significance. Nevertheless, several significant associations were identified. For inflammatory arthritis, intakes of carbohydrates (Q3 OR 0.26, 95% CI 0.13–0.49; p=0.019) and total energy (Q3 OR 0.31, 95% CI 0.16–0.60; p=0.047) within the third quartile of the intake distribution were associated with lower odds of disease. Several non-significant trends were observed for cardiometabolic outcomes. For example, higher saturated fat intake (Q4 OR 1.29, 95% CI 1.04–1.60; p=0.218) and higher cholesterol intake (Q4 OR 1.39, 95% CI 1.11–1.73; p=0.095) showed a trend of increased odds of hypertension.

```{r}
# Univariable analysis 1: core covariates------------------------------------------------------
## Define univariable analysis 1 predictors
uni1_predictors <- c(
  "age",
  "sex",
  "race",
  "insur",
  "educ",
  "pir",
  "food_sec",
  "smoking",
  "phys_act",
  "alcohol",
  "sbp_cat",
  "dbp_cat",
  "bmi_cat",
  "whtr_cat",
  "hdl",
  "non_hdl",
  "tchol",
  "hba1c",
  "vitD25oh_cat",
  "vitD25oh_cat_trend",
  "dii",
  "dii_quart_trend",
  "dii_etoh"
)

uni1_predictor_order <- uni1_predictors

## Helper function to clean Vitamin D and DII labels
clean_vitD_DII_labels <- function(df) {
  df |>
    mutate(
      variable_label = as.character(variable_label),
      variable_label = str_replace_all(variable_label, "25\\(OH\\)D", "Vitamin D"),
      variable_label = str_replace(
        variable_label,
        "Vitamin D category trend \\(0–2\\)",
        "Vitamin D category trend"
      ),
      variable_label = str_replace(
        variable_label,
        "category trend \\(0–2\\)",
        "category trend"
      ),
      variable_label = str_replace(
        variable_label,
        "Dietary Inflammatory Index \\(per unit\\)",
        "DII"
      ),
      variable_label = str_replace(
        variable_label,
        "DII including alcohol \\(per unit\\)",
        "DII including alcohol"
      ),
      variable_label = str_replace(
        variable_label,
        "DII quartile trend \\(0–3\\)",
        "DII quartile trend"
      ),
      variable_label = factor(variable_label)
    )
}

## Helper function for univariable tables in gt
make_uni_gt <- function(data, title_text) {
  data |>
    gt() |>
    tab_header(
      title = md(title_text)
    ) |>
    fmt_markdown(columns = everything()) |>
    tab_options(table.font.size = px(10)) |>
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_column_labels(everything())
    ) |>
    tab_footnote(
      footnote = "p values were corrected for multiple comparisons using the Benjamini-Hochberg false discovery rate (FDR) method",
      locations = cells_column_labels(columns = contains("p value"))
    )
}

## Univariable analysis 1 helper function
run_uni_model1 <- function(outcome_name, outcome_info, predictor) {
  des <- outcome_info$design
  y   <- outcome_info$var

  if (!predictor %in% names(des$variables)) {
    warning("Predictor ", predictor, " not found in design for outcome ", outcome_name, ". Skipping.")
    return(tibble())
  }

  form_uni <- as.formula(paste0(y, " ~ ", predictor))

  fit <- svyglm(
    form_uni,
    design = des,
    family = quasibinomial()
  )

  td <- tidy(fit, exponentiate = TRUE, conf.int = TRUE) |>
    filter(term != "(Intercept)") |>
    mutate(
      outcome     = outcome_name,
      outcome_lab = outcome_info$label,
      predictor   = predictor
    )

  base_label <- uni1_labels[[predictor]]
  if (is.null(base_label)) base_label <- predictor

  add_ref_and_label(
    td           = td,
    des          = des,
    predictor    = predictor,
    outcome_name = outcome_name,
    outcome_info = outcome_info,
    base_label   = base_label
  )
}

## Univariable analysis 1 primary outcomes
uni1_primary_long <- map_dfr(
  names(outcome_list),
  function(out_nm) {
    info <- outcome_list[[out_nm]]
    map_dfr(uni1_predictors, ~ run_uni_model1(out_nm, info, .x))
  }
)

uni1_primary_long <- uni1_primary_long |>
  rename(
    OR  = estimate,
    LCL = conf.low,
    UCL = conf.high,
    p   = p.value
  ) |>
  mutate(
    p_fdr = p.adjust(p, method = "BH"),
    or_ci = if_else(
      is.na(p) & OR == 1 & LCL == 1 & UCL == 1,
      "1 (Ref)",
      sprintf("%.2f (%.2f, %.2f)", OR, LCL, UCL)
    ),
    p_fdr_fmt = ifelse(is.na(p_fdr), "", pvalue(p_fdr, accuracy = 0.001))
  ) |>
  ### Use predictor and variable_label to pull in ranks for ordering
  left_join(custom_order_uni1, by = c("predictor", "variable_label")) |>
  mutate(
    predictor = factor(predictor, levels = uni1_predictor_order),
    rank      = coalesce(rank, 1000L)
  ) |>
  clean_vitD_DII_labels() |>
  ### Override rank for specific predictors/levels to re-order
  mutate(
    rank2 = case_when(
      predictor == "educ" & str_detect(variable_label, "Education: <9 years")       ~ 1L,
      predictor == "educ" & str_detect(variable_label, "Education: 9–12 years")     ~ 2L,
      predictor == "educ" & str_detect(variable_label, "Education: >12 years")      ~ 3L,

      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Underweight") ~ 1L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Normal")     ~ 2L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Overweight") ~ 3L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Obesity I")  ~ 4L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Obesity II") ~ 5L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Obesity III")~ 6L,

      predictor == "vitD25oh_cat" & str_detect(variable_label, "Vitamin D category: <20")   ~ 1L,
      predictor == "vitD25oh_cat" & str_detect(variable_label, "Vitamin D category: 20–29") ~ 2L,
      predictor == "vitD25oh_cat" & str_detect(variable_label, "Vitamin D category: ≥30")   ~ 3L,

      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: <120")    ~ 1L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: 120–129") ~ 2L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: 130–139") ~ 3L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: 140–159") ~ 4L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: ≥160")    ~ 5L,

      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: <80")    ~ 1L,
      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: 80–89")  ~ 2L,
      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: 90–99")  ~ 3L,
      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: ≥100")   ~ 4L,

      predictor == "whtr_cat" & str_detect(variable_label, "Waist-to-height ratio category: <0.5")     ~ 1L,
      predictor == "whtr_cat" & str_detect(variable_label, "Waist-to-height ratio category: 0.5–0.59") ~ 2L,
      predictor == "whtr_cat" & str_detect(variable_label, "Waist-to-height ratio category: ≥0.6")     ~ 3L,

      TRUE ~ rank
    )
  ) |>
  arrange(predictor, rank2, variable_label, outcome_lab)

uni1_primary_wide <- uni1_primary_long |>
  select(
    variable_label,
    outcome_lab,
    or_ci,
    p_fdr_fmt
  ) |>
  pivot_wider(
    id_cols    = variable_label,
    names_from = outcome_lab,
    values_from = c(or_ci, p_fdr_fmt),
    names_glue = "{outcome_lab} {.value}"
  ) |>
  rename_with(~ str_replace(.x, " or_ci", " OR (95% CI)")) |>
  rename_with(~ str_replace(.x, " p_fdr_fmt", " p value")) |>
  rename(Variable = variable_label)

uni1_primary_outcomes_order <- c(
  "Asthma",
  "Allergic rhinitis",
  "Inflammatory arthritis",
  "Diabetes",
  "Hypertension"
)

uni1_primary_col_order <- c(
  "Variable",
  as.vector(rbind(
    paste0(uni1_primary_outcomes_order, " OR (95% CI)"),
    paste0(uni1_primary_outcomes_order, " p value")
  ))
)

uni1_primary_wide <- uni1_primary_wide |>
  select(all_of(uni1_primary_col_order))

tbl_uni1_primary <- make_uni_gt(
  uni1_primary_wide,
  "**Table 5: Univariable Associations of Core Covariates With Asthma, Allergic Rhinitis, Inflammatory Arthritis, Diabetes, and Hypertension**"
)

## Univariable analysis 1 secondary outcomes
uni1_secondary_long <- map_dfr(
  names(outcome_list_secondary),
  function(out_nm) {
    info <- outcome_list_secondary[[out_nm]]
    map_dfr(uni1_predictors, ~ run_uni_model1(out_nm, info, .x))
  }
)

uni1_secondary_long <- uni1_secondary_long |>
  rename(
    OR  = estimate,
    LCL = conf.low,
    UCL = conf.high,
    p   = p.value
  ) |>
  mutate(
    p_fdr   = p.adjust(p, method = "BH"),
    or_ci   = if_else(
      is.na(p) & OR == 1 & LCL == 1 & UCL == 1,
      "1 (Ref)",
      sprintf("%.2f (%.2f, %.2f)", OR, LCL, UCL)
    ),
    p_fdr_fmt = ifelse(is.na(p_fdr), "", pvalue(p_fdr, accuracy = 0.001))
  ) |>
  left_join(custom_order_uni1, by = c("predictor", "variable_label")) |>
  mutate(
    predictor = factor(predictor, levels = uni1_predictor_order),
    rank      = coalesce(rank, 1000L)
  ) |>
  clean_vitD_DII_labels() |>
  mutate(
    rank2 = case_when(
      predictor == "educ" & str_detect(variable_label, "Education: <9 years")       ~ 1L,
      predictor == "educ" & str_detect(variable_label, "Education: 9–12 years")     ~ 2L,
      predictor == "educ" & str_detect(variable_label, "Education: >12 years")      ~ 3L,

      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Underweight") ~ 1L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Normal")     ~ 2L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Overweight") ~ 3L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Obesity I")  ~ 4L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Obesity II") ~ 5L,
      predictor == "bmi_cat" & str_detect(variable_label, "BMI category: Obesity III")~ 6L,

      predictor == "vitD25oh_cat" & str_detect(variable_label, "Vitamin D category: <20")   ~ 1L,
      predictor == "vitD25oh_cat" & str_detect(variable_label, "Vitamin D category: 20–29") ~ 2L,
      predictor == "vitD25oh_cat" & str_detect(variable_label, "Vitamin D category: ≥30")   ~ 3L,

      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: <120")    ~ 1L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: 120–129") ~ 2L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: 130–139") ~ 3L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: 140–159") ~ 4L,
      predictor == "sbp_cat" & str_detect(variable_label, "Systolic blood pressure category: ≥160")    ~ 5L,

      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: <80")    ~ 1L,
      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: 80–89")  ~ 2L,
      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: 90–99")  ~ 3L,
      predictor == "dbp_cat" & str_detect(variable_label, "Diastolic blood pressure category: ≥100")   ~ 4L,

      predictor == "whtr_cat" & str_detect(variable_label, "Waist-to-height ratio category: <0.5")     ~ 1L,
      predictor == "whtr_cat" & str_detect(variable_label, "Waist-to-height ratio category: 0.5–0.59") ~ 2L,
      predictor == "whtr_cat" & str_detect(variable_label, "Waist-to-height ratio category: ≥0.6")     ~ 3L,

      TRUE ~ rank
    )
  ) |>
  arrange(predictor, rank2, variable_label, outcome_lab)

uni1_secondary_wide <- uni1_secondary_long |>
  select(
    variable_label,
    outcome_lab,
    or_ci,
    p_fdr_fmt
  ) |>
  pivot_wider(
    id_cols    = variable_label,
    names_from = outcome_lab,
    values_from = c(or_ci, p_fdr_fmt),
    names_glue = "{outcome_lab} {.value}"
  ) |>
  rename_with(~ str_replace(.x, " or_ci", " OR (95% CI)")) |>
  rename_with(~ str_replace(.x, " p_fdr_fmt", " p value")) |>
  rename(Variable = variable_label)

uni1_secondary_outcomes_order <- c(
  "Atopic dermatitis",
  "Food allergy"
)

uni1_secondary_col_order <- c(
  "Variable",
  as.vector(rbind(
    paste0(uni1_secondary_outcomes_order, " OR (95% CI)"),
    paste0(uni1_secondary_outcomes_order, " p value")
  ))
)

uni1_secondary_wide <- uni1_secondary_wide |>
  select(all_of(uni1_secondary_col_order))

tbl_uni1_secondary <- make_uni_gt(
  uni1_secondary_wide,
  "**Table 6: Univariable Associations of Core Covariates With Eczema and Food Allergy**"
)

# Univariable modeling 2: individual DII nutrient quartiles------------------------------------
## Define univariable analysis 2 predictors
dii_nutrient_bases <- c(
  "kcal", "carb", "protein", "totalfat", "satfat",
  "pufa", "mufa", "n3fat", "n6fat", "choles",
  "vitA", "bcarotene", "vitC", "vitE",
  "vitB6", "vitB12", "folicacid",
  "thiamin", "riboflavin", "niacin",
  "iron", "mg", "zn", "se",
  "fiber", "caffeine"
)

nutrient_labels <- c(
  kcal       = "Total energy intake (kcal)",
  carb       = "Carbohydrate intake",
  protein    = "Protein intake",
  totalfat   = "Total fat intake",
  satfat     = "Saturated fat intake",
  pufa       = "Polyunsaturated fat intake",
  mufa       = "Monounsaturated fat intake",
  n3fat      = "Omega-3 fat intake",
  n6fat      = "Omega-6 fat intake",
  choles     = "Cholesterol intake",
  vitA       = "Vitamin A intake",
  bcarotene  = "Beta-carotene intake",
  vitC       = "Vitamin C intake",
  vitE       = "Vitamin E intake",
  vitB6      = "Vitamin B6 intake",
  vitB12     = "Vitamin B12 intake",
  folicacid  = "Folic acid intake",
  thiamin    = "Thiamin intake",
  riboflavin = "Riboflavin intake",
  niacin     = "Niacin intake",
  iron       = "Iron intake",
  mg         = "Magnesium intake",
  zn         = "Zinc intake",
  se         = "Selenium intake",
  fiber      = "Fiber intake",
  caffeine   = "Caffeine intake"
)

dii_nutrient_quart_predictors <- paste0(dii_nutrient_bases, "_quart")

## Univariable analysis 2 helper function
run_uni_model2 <- function(outcome_name, outcome_info, predictor) {
  des <- outcome_info$design
  y   <- outcome_info$var

  if (!predictor %in% names(des$variables)) {
    warning("Predictor ", predictor, " not found in design for outcome ", outcome_name, ". Skipping.")
    return(tibble())
  }

  form_uni <- as.formula(paste0(y, " ~ ", predictor))

  fit <- svyglm(
    form_uni,
    design = des,
    family = quasibinomial()
  )

  td <- tidy(fit, exponentiate = TRUE, conf.int = TRUE) |>
    filter(term != "(Intercept)") |>
    mutate(
      outcome     = outcome_name,
      outcome_lab = outcome_info$label,
      predictor   = predictor
    )

  base       <- sub("_quart$", "", predictor)
  base_label <- nutrient_labels[[base]]
  if (is.null(base_label)) base_label <- base

  var_data <- des$variables[[predictor]]
  if (is.character(var_data)) {
    var_data <- factor(var_data)
  }

  if (is.factor(var_data)) {
    levels_vec <- levels(var_data)
    pattern    <- paste0("^", predictor)

    td_nonref <- td |>
      mutate(
        level          = sub(pattern, "", term),
        variable_label = paste0(base_label, ": ", level)
      )

    ref_level <- levels_vec[1]
    ref_label <- paste0(base_label, ": ", ref_level)

    ref_row <- tibble(
      term           = paste0(predictor, ref_level),
      estimate       = 1,
      conf.low       = 1,
      conf.high      = 1,
      p.value        = NA_real_,
      outcome        = outcome_name,
      outcome_lab    = outcome_info$label,
      predictor      = predictor,
      level          = ref_level,
      variable_label = ref_label
    )

    bind_rows(ref_row, td_nonref)
  } else {
    td |>
      mutate(variable_label = base_label)
  }
}

## Univariable analysis 2 primary outcomes
uni2_primary_long <- map_dfr(
  names(outcome_list),
  function(out_nm) {
    info <- outcome_list[[out_nm]]
    map_dfr(dii_nutrient_quart_predictors, ~ run_uni_model2(out_nm, info, .x))
  }
)

uni2_primary_long <- uni2_primary_long |>
  rename(
    OR  = estimate,
    LCL = conf.low,
    UCL = conf.high,
    p   = p.value
  ) |>
  mutate(
    p_fdr   = p.adjust(p, method = "BH"),
    or_ci   = if_else(
      is.na(p) & OR == 1 & LCL == 1 & UCL == 1,
      "1 (Ref)",
      sprintf("%.2f (%.2f, %.2f)", OR, LCL, UCL)
    ),
    p_fdr_fmt = ifelse(is.na(p_fdr), "", pvalue(p_fdr, accuracy = 0.001))
  ) |>
  mutate(
    base           = sub("_quart$", "", predictor),
    base           = factor(base, levels = dii_nutrient_bases),
    variable_label = factor(variable_label)
  ) |>
  arrange(base, variable_label, outcome_lab)

uni2_primary_wide <- uni2_primary_long |>
  select(
    variable_label,
    outcome_lab,
    or_ci,
    p_fdr_fmt
  ) |>
  pivot_wider(
    id_cols    = variable_label,
    names_from = outcome_lab,
    values_from = c(or_ci, p_fdr_fmt),
    names_glue = "{outcome_lab} {.value}"
  ) |>
  rename_with(~ str_replace(.x, " or_ci", " OR (95% CI)")) |>
  rename_with(~ str_replace(.x, " p_fdr_fmt", " p value")) |>
  rename(Variable = variable_label)

uni2_primary_outcomes_order <- c(
  "Asthma",
  "Allergic rhinitis",
  "Inflammatory arthritis",
  "Diabetes",
  "Hypertension"
)

uni2_primary_col_order <- c(
  "Variable",
  as.vector(rbind(
    paste0(uni2_primary_outcomes_order, " OR (95% CI)"),
    paste0(uni2_primary_outcomes_order, " p value")
  ))
)

uni2_primary_wide <- uni2_primary_wide |>
  select(all_of(uni2_primary_col_order))

tbl_uni2_primary <- make_uni_gt(
  uni2_primary_wide,
  "**Table 7: Univariable Associations of Individual Nutritional Covariates With Asthma, Allergic Rhinitis, Inflammatory Arthritis, Diabetes, and Hypertension**"
)

## Univariable analysis 2 secondary outcomes
uni2_secondary_long <- map_dfr(
  names(outcome_list_secondary),
  function(out_nm) {
    info <- outcome_list_secondary[[out_nm]]
    map_dfr(dii_nutrient_quart_predictors, ~ run_uni_model2(out_nm, info, .x))
  }
)

uni2_secondary_long <- uni2_secondary_long |>
  rename(
    OR  = estimate,
    LCL = conf.low,
    UCL = conf.high,
    p   = p.value
  ) |>
  mutate(
    p_fdr   = p.adjust(p, method = "BH"),
    or_ci   = if_else(
      is.na(p) & OR == 1 & LCL == 1 & UCL == 1,
      "1 (Ref)",
      sprintf("%.2f (%.2f, %.2f)", OR, LCL, UCL)
    ),
    p_fdr_fmt = ifelse(is.na(p_fdr), "", pvalue(p_fdr, accuracy = 0.001))
  ) |>
  mutate(
    base           = sub("_quart$", "", predictor),
    base           = factor(base, levels = dii_nutrient_bases),
    variable_label = factor(variable_label)
  ) |>
  arrange(base, variable_label, outcome_lab)

uni2_secondary_wide <- uni2_secondary_long |>
  select(
    variable_label,
    outcome_lab,
    or_ci,
    p_fdr_fmt
  ) |>
  pivot_wider(
    id_cols    = variable_label,
    names_from = outcome_lab,
    values_from = c(or_ci, p_fdr_fmt),
    names_glue = "{outcome_lab} {.value}"
  ) |>
  rename_with(~ str_replace(.x, " or_ci", " OR (95% CI)")) |>
  rename_with(~ str_replace(.x, " p_fdr_fmt", " p value")) |>
  rename(Variable = variable_label)

uni2_secondary_outcomes_order <- c(
  "Atopic dermatitis",
  "Food allergy"
)

uni2_secondary_col_order <- c(
  "Variable",
  as.vector(rbind(
    paste0(uni2_secondary_outcomes_order, " OR (95% CI)"),
    paste0(uni2_secondary_outcomes_order, " p value")
  ))
)

uni2_secondary_wide <- uni2_secondary_wide |>
  select(all_of(uni2_secondary_col_order))

tbl_uni2_secondary <- make_uni_gt(
  uni2_secondary_wide,
  "**Table 8: Univariable Associations of Individual Nutritional Covariates With Eczema and Food Allergy**"
)

# Print univariable analysis tables------------------------------------------------------------
tbl_uni1_primary
tbl_uni1_secondary
tbl_uni2_primary
tbl_uni2_secondary
```

**Multivariable regression analyses**

Survey-weighted multivariable logistic regression models were used to assess the association between DII score and each disease outcome after adjustment for covariates of interest. Three models were generated. Model 1 adjusted for age and sex. Model 2 additionally adjusted for race/ethnicity, insurance status, poverty-income ratio, and education level. Model 3 further adjusted for BMI, physical activity, and smoking status. Results are shown in **Figure 2** for asthma, allergic rhinitis, inflammatory arthritis, diabetes, and hypertension and in **Figure 3** for eczema and food allergy.

Overall, there were few significant associations across the models. For allergic rhinitis, higher DII was associated with lower odds in Model 1 (OR 0.95, 95% CI 0.91–0.99; p=0.01), but this association was not statistically significant in Model 2 (OR 0.96, 95% CI 0.92–1.00; p=0.054) or Model 3 (OR 0.97, 95% CI 0.92–1.01; p=0.113). Among cardiometabolic outcomes, higher DII was associated with increased odds of hypertension in Model 1 (OR 1.07, 95% CI 1.03–1.12; p\<0.001) and Model 2 (OR 1.06, 95% CI 1.01–1.10; p=0.011). However, this association was not statistically significant in Model 3 (OR 1.03, 95% CI 0.99–1.08; p=0.149). For secondary outcomes, higher DII was associated with decreased odds of food allergy only in Model 1 (OR 0.93, 95% CI 0.89–0.98; p=0.006).

```{r}
# Adjusted multivariable models----------------------------------------------------------------
## Variables for models 1, 2, 3
covariates_m1 <- c("age", "sex")
covariates_m2 <- c("age", "sex", "race", "insur", "pir", "educ")
covariates_m3 <- c("age", "sex", "race", "insur", "pir", "educ", "bmi_cat", "phys_act", "smoking")

## Helper function to build regression formulas
make_dii_formula <- function(outcome_var, covariates) {
  rhs <- c(covariates, "dii")
  as.formula(
    paste(outcome_var, "~", paste(rhs, collapse = " + "))
  )
}

## Fit models for primary outcomes
fit_primary_models <- imap(
  outcome_list,
  ~ list(
    label  = .x$label,
    design = .x$design,
    m1 = svyglm(
      make_dii_formula(.x$var, covariates_m1),
      design = .x$design,
      family = quasibinomial()
    ),
    m2 = svyglm(
      make_dii_formula(.x$var, covariates_m2),
      design = .x$design,
      family = quasibinomial()
    ),
    m3 = svyglm(
      make_dii_formula(.x$var, covariates_m3),
      design = .x$design,
      family = quasibinomial()
    )
  )
)

## Fit models for secondary outcomes
fit_secondary_models <- imap(
  outcome_list_secondary,
  ~ list(
    label  = .x$label,
    design = .x$design,
    m1 = svyglm(
      make_dii_formula(.x$var, covariates_m1),
      design = .x$design,
      family = quasibinomial()
    ),
    m2 = svyglm(
      make_dii_formula(.x$var, covariates_m2),
      design = .x$design,
      family = quasibinomial()
    ),
    m3 = svyglm(
      make_dii_formula(.x$var, covariates_m3),
      design = .x$design,
      family = quasibinomial()
    )
  )
)

# Extract adjusted multivariable associations from models 1-3----------------------------------
extract_dii_from_model <- function(fit, outcome_label, model_label) {
  td <- broom::tidy(fit, exponentiate = TRUE, conf.int = TRUE) |>
    filter(term == "dii")

  if (nrow(td) == 0) {
    return(tibble(
      outcome_lab   = outcome_label,
      model         = model_label,
      OR            = NA_real_,
      LCL           = NA_real_,
      UCL           = NA_real_,
      p             = NA_real_,
      `OR (95% CI)` = "NE",
      `p value`     = NA_character_,
      is_ne         = TRUE
    ))
  }

  OR  <- td$estimate[1]
  LCL <- td$conf.low[1]
  UCL <- td$conf.high[1]
  p   <- td$p.value[1]

  is_ne <- !is.finite(OR) | !is.finite(LCL) | !is.finite(UCL) |
    OR <= 0 | LCL <= 0 | UCL <= 0 |
    is.na(OR) | is.na(LCL) | is.na(UCL) |
    abs(log(OR)) > 10 | abs(log(LCL)) > 10 | abs(log(UCL)) > 10

  if (is_ne) {
    or_ci_str <- "NE"
    p_str     <- NA_character_
  } else {
    or_ci_str <- sprintf("%.2f (%.2f, %.2f)", OR, LCL, UCL)
    p_str     <- scales::pvalue(p, accuracy = 0.001)
  }

  tibble(
    outcome_lab   = outcome_label,
    model         = model_label,
    OR            = ifelse(is_ne, NA_real_, OR),
    LCL           = ifelse(is_ne, NA_real_, LCL),
    UCL           = ifelse(is_ne, NA_real_, UCL),
    p             = ifelse(is_ne, NA_real_, p),
    `OR (95% CI)` = or_ci_str,
    `p value`     = p_str,
    is_ne         = is_ne
  )
}

## Primary outcomes in adjusted models 1–3
dii_primary_models_long <- map_dfr(
  fit_primary_models,
  function(m) {
    bind_rows(
      extract_dii_from_model(m$m1, m$label, "Model 1"),
      extract_dii_from_model(m$m2, m$label, "Model 2"),
      extract_dii_from_model(m$m3, m$label, "Model 3")
    )
  }
)

## Secondary outcomes in adjusted models 1–3
dii_secondary_models_long <- map_dfr(
  fit_secondary_models,
  function(m) {
    bind_rows(
      extract_dii_from_model(m$m1, m$label, "Model 1"),
      extract_dii_from_model(m$m2, m$label, "Model 2"),
      extract_dii_from_model(m$m3, m$label, "Model 3")
    )
  }
)

# Forest plots for multivariable associations--------------------------------------------------
## Helper function to construct label columns for OR and p values
add_or_p_labels <- function(df) {
  df |>
    mutate(
      or_label = if_else(`OR (95% CI)` == "NE", "NE", `OR (95% CI)`),
      p_label  = if_else(
        is.na(`p value`),
        "",
        paste0("p = ", `p value`)
      )
    )
}

## DII associations with primary outcomes
dii_primary_plot_data <- dii_primary_models_long |>
  add_or_p_labels() |>
  mutate(
    outcome_lab = factor(
      outcome_lab,
      levels = c(
        "Asthma",
        "Allergic rhinitis",
        "Inflammatory arthritis",
        "Diabetes",
        "Hypertension"
      )
    ),
    # Adjust model levels (more-adjusted model on top)
    model_label = factor(
      model,
      levels = c("Model 3", "Model 2", "Model 1")
    )
  )

## Compute axis limits
dii_primary_limits <- dii_primary_plot_data |>
  filter(!is_ne) |>
  summarise(
    xmin = min(LCL, na.rm = TRUE),
    xmax = max(UCL, na.rm = TRUE)
  )

x_min_primary <- pmax(0.1, dii_primary_limits$xmin * 0.9)
x_max_primary <- pmin(2.5, dii_primary_limits$xmax * 1.1)

dii_primary_forest_plot <- dii_primary_plot_data |>
  filter(!is_ne) |>
  ggplot(
    aes(
      x = OR,
      y = model_label
    )
  ) +
  geom_point() +
  geom_errorbarh(aes(xmin = LCL, xmax = UCL), height = 0.15) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_text(
    aes(
      label = paste0(or_label, "\n", p_label),
      x     = pmin(UCL, x_max_primary * 0.95)
    ),
    hjust = -0.05,
    size  = 3.5
  ) +
  scale_x_continuous(
    limits = c(x_min_primary, x_max_primary),
    expand = expansion(mult = c(0.02, 0.1))
  ) +
  facet_wrap(~ outcome_lab, ncol = 2) +
  labs(
    x     = "Adjusted odds ratio for Dietary Inflammatory Index",
    y     = NULL,
    title = "Figure 2: Adjusted Multivariable Associations Between Dietary Inflammatory Index\nand Asthma, Allergic Rhinitis, Inflammatory Arthritis, Diabetes, or Hypertension"
  ) +
  theme_minimal() +
  theme(
    plot.title    = element_text(face = "bold", size = 13, hjust = 0.5),
    strip.text    = element_text(face = "bold", size = 11),
    axis.text.y   = element_text(face = "bold", size = 10),
    axis.text.x   = element_text(size = 10),
    axis.title.x  = element_text(face = "bold", size = 11),
    panel.spacing = grid::unit(0.4, "lines")
  )

## DII associations with secondary outcomes
dii_secondary_plot_data <- dii_secondary_models_long |>
  mutate(
    outcome_lab = recode(
      outcome_lab,
      "Atopic dermatitis" = "Eczema"
    )
  ) |>
  add_or_p_labels() |>
  mutate(
    outcome_lab = factor(
      outcome_lab,
      levels = c("Eczema", "Food allergy")
    ),
    model_label = factor(
      model,
      levels = c("Model 3", "Model 2", "Model 1")
    )
  )

dii_secondary_limits <- dii_secondary_plot_data |>
  filter(!is_ne) |>
  summarise(
    xmin = min(LCL, na.rm = TRUE),
    xmax = max(UCL, na.rm = TRUE)
  )

x_min_secondary <- pmax(0.1, dii_secondary_limits$xmin * 0.9)
x_max_secondary <- pmin(2.5, dii_secondary_limits$xmax * 1.1)

dii_secondary_forest_plot <- dii_secondary_plot_data |>
  filter(!is_ne) |>
  ggplot(
    aes(
      x = OR,
      y = model_label
    )
  ) +
  geom_point() +
  geom_errorbarh(aes(xmin = LCL, xmax = UCL), height = 0.15) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_text(
    aes(
      label = paste0(or_label, "\n", p_label),
      x     = pmin(UCL, x_max_secondary * 0.95)
    ),
    hjust = -0.05,
    size  = 3.5
  ) +
  scale_x_continuous(
    limits = c(x_min_secondary, x_max_secondary),
    expand = expansion(mult = c(0.02, 0.1))
  ) +
  facet_wrap(~ outcome_lab, ncol = 1) +
  labs(
    x       = "Adjusted odds ratio for Dietary Inflammatory Index",
    y       = NULL,
    title   = "Figure 3: Adjusted Multivariable Associations Between Dietary Inflammatory Index\nand Eczema or Food Allergy",
    caption = "Note: Model 3 was not estimatable for eczema because of sparse outcome counts."
  ) +
  theme_minimal() +
  theme(
    plot.title    = element_text(face = "bold", size = 13, hjust = 0.5),
    strip.text    = element_text(face = "bold", size = 11),
    axis.text.y   = element_text(face = "bold", size = 10),
    axis.text.x   = element_text(size = 10),
    axis.title.x  = element_text(face = "bold", size = 11),
    panel.spacing = grid::unit(0.4, "lines")
  )

# Print forest plots---------------------------------------------------------------------------
dii_primary_forest_plot
dii_secondary_forest_plot
```

**Effect modification analyses**

Effect modification analyses were performed to assess whether the association between DII and each disease outcome differed by sex, BMI category, or vitamin D status. Results are shown in **Table 9** for asthma, allergic rhinitis, inflammatory arthritis, diabetes, and hypertension, and in **Table 10** for eczema and food allergy. Overall, only a few interactions were statistically significant and generally without a clear trend across categories. For inflammatory arthritis, BMI significantly modified the association (p\<0.001), but without a clear trend across BMI categories. For diabetes, vitamin D status significantly modified the association (p\<0.001), with those with vitamin D deficiency exhibiting a higher association between DII and diabetes (OR 1.70, 95% CI 1.13–2.57). However, those with vitamin D insufficiency exhibited a reduced association (OR 0.81, 95% CI 0.65–0.99). For secondary outcomes, eczema demonstrated a significant interaction with BMI (p=0.012), with an increased association seen among those who were underweight (OR 2.20, 95% CI 1.25–3.88). No significant interaction terms were observed for sex.

```{r}
# Effect modification analyses-----------------------------------------------------------------
effectmod_modifiers <- tibble(
  modifier_var   = c("sex",        "bmi_cat",        "vitD25oh_cat"),
  modifier_label = c("Sex",        "BMI category",   "Vitamin D category")
)

fit_dii_interaction_model <- function(outcome_info, covariates_base, modifier_var) {
  outcome_var <- outcome_info$var

  base_covars <- covariates_base
  if (!(modifier_var %in% base_covars)) {
    base_covars <- c(base_covars, modifier_var)
  }

  rhs_terms <- c("dii", modifier_var, paste0("dii:", modifier_var), base_covars)
  rhs_terms <- unique(rhs_terms)

  f <- as.formula(
    paste(
      outcome_var,
      "~",
      paste(rhs_terms, collapse = " + ")
    )
  )

  svyglm(
    f,
    design = outcome_info$design,
    family = quasibinomial()
  )
}

run_dii_effectmod <- function(fit, outcome_label, modifier_var, modifier_label) {
  cf <- coef(fit)
  V  <- vcov(fit)
  mf <- model.frame(fit)

  mod <- mf[[modifier_var]]
  if (!is.factor(mod)) {
    mod <- factor(mod)
  }
  levels_mod <- levels(mod)

  int_pattern1 <- paste0("^dii:", modifier_var)
  int_pattern2 <- paste0("^", modifier_var, ".*:dii")

  interaction_terms <- names(cf)[
    grepl(int_pattern1, names(cf)) | grepl(int_pattern2, names(cf))
  ]

  if (length(interaction_terms) > 0) {
    beta_int <- cf[interaction_terms]
    V_int    <- V[interaction_terms, interaction_terms, drop = FALSE]

    stat  <- as.numeric(t(beta_int) %*% solve(V_int) %*% beta_int)
    df    <- length(beta_int)
    p_int <- 1 - pchisq(stat, df = df)
  } else {
    p_int <- NA_real_
  }

  map_dfr(
    seq_along(levels_mod),
    function(j) {
      lvl <- levels_mod[j]

      if (!("dii" %in% names(cf))) {
        return(tibble())
      }

      beta_dii <- cf[["dii"]]
      var_dii  <- V["dii", "dii"]

      if (j == 1L) {
        beta <- beta_dii
        var  <- var_dii
      } else {
        int_name_candidates <- c(
          paste0("dii:", modifier_var, lvl),
          paste0(modifier_var, lvl, ":dii")
        )
        int_name <- int_name_candidates[int_name_candidates %in% names(cf)]

        if (length(int_name) == 0L) {
          return(tibble())
        }

        int_name <- int_name[1]

        beta_int <- cf[[int_name]]
        var_int  <- V[int_name, int_name]
        covar    <- V["dii", int_name]

        beta <- beta_dii + beta_int
        var  <- var_dii + var_int + 2 * covar
      }

      se <- sqrt(var)

      OR  <- exp(beta)
      LCL <- exp(beta - 1.96 * se)
      UCL <- exp(beta + 1.96 * se)

      is_ne <- !is.finite(OR) | !is.finite(LCL) | !is.finite(UCL) |
        OR <= 0 | LCL <= 0 | UCL <= 0 |
        is.na(OR) | is.na(LCL) | is.na(UCL) |
        abs(log(OR)) > 10 | abs(log(LCL)) > 10 | abs(log(UCL)) > 10

      if (is_ne) {
        or_ci_str <- "NE"
      } else {
        or_ci_str <- sprintf("%.2f (%.2f, %.2f)", OR, LCL, UCL)
      }

      tibble(
        outcome_lab    = outcome_label,
        modifier_var   = modifier_var,
        modifier_label = modifier_label,
        level          = lvl,
        OR             = ifelse(is_ne, NA_real_, OR),
        LCL            = ifelse(is_ne, NA_real_, LCL),
        UCL            = ifelse(is_ne, NA_real_, UCL),
        is_ne          = is_ne,
        `OR (95% CI)`  = or_ci_str,
        p_int          = p_int
      )
    }
  )
}

## Level order for BMI and Vitamin D
bmi_level_order <- c(
  "Underweight (<18.5)",
  "Normal (18.5–24.9)",
  "Overweight (25–29.9)",
  "Obesity I (30–34.9)",
  "Obesity II (35–39.9)",
  "Obesity III (≥40)"
)

vitD_level_order <- c(
  "<20 (deficient)",
  "20–29 (insufficient)",
  "≥30 (sufficient)"
)

## Helper function to build display table
build_effectmod_display <- function(df) {
  df |>
    arrange(outcome_lab, modifier_var, level) |>
    group_by(outcome_lab, modifier_var, modifier_label) |>
    group_split() |>
    map_dfr(function(grp) {
      out_name <- grp$outcome_lab[[1]]
      mod_lab  <- grp$modifier_label[[1]]

      ### Fix modifier text
      mod_label_clean <- case_when(
        mod_lab == "BMI category"       ~ "by BMI category",
        mod_lab == "Vitamin D category" ~ "by Vitamin D category",
        TRUE                            ~ paste0("by ", tolower(mod_lab))
      )

      p_int_vals <- grp$`p for interaction`[!is.na(grp$`p for interaction`)]
      p_int_disp <- ifelse(length(p_int_vals) == 0, NA_character_, p_int_vals[1])

      header_row <- tibble(
        Outcome             = out_name,
        `Modifier level`    = paste0(out_name, " ", mod_label_clean),
        `OR (95% CI)`       = "",
        `p for interaction` = p_int_disp
      )

      level_rows <- grp |>
        transmute(
          Outcome             = out_name,
          `Modifier level`    = as.character(level),
          `OR (95% CI)`       = `OR (95% CI)`,
          `p for interaction` = ""
        )

      bind_rows(header_row, level_rows)
    })
}

## Effect modification for primary outcomes
effectmod_primary_long <- map_dfr(
  names(outcome_list),
  function(out_nm) {
    outcome_info <- outcome_list[[out_nm]]

    map_dfr(
      seq_len(nrow(effectmod_modifiers)),
      function(i) {
        mod_var   <- effectmod_modifiers$modifier_var[i]
        mod_label <- effectmod_modifiers$modifier_label[i]

        fit_int <- fit_dii_interaction_model(
          outcome_info    = outcome_info,
          covariates_base = covariates_m3,
          modifier_var    = mod_var
        )

        run_dii_effectmod(
          fit            = fit_int,
          outcome_label  = outcome_info$label,
          modifier_var   = mod_var,
          modifier_label = mod_label
        )
      }
    )
  }
) |>
  mutate(
    `p for interaction` = ifelse(
      is.na(p_int),
      NA_character_,
      scales::pvalue(p_int, accuracy = 0.001)
    )
  )

effectmod_primary_long <- effectmod_primary_long |>
  mutate(
    modifier_var = factor(
      modifier_var,
      levels = c("sex", "bmi_cat", "vitD25oh_cat")
    ),
    level = as.character(level)
  ) |>
  mutate(
    level = case_when(
      modifier_var == "bmi_cat"      ~ factor(level, levels = bmi_level_order),
      modifier_var == "vitD25oh_cat" ~ factor(level, levels = vitD_level_order),
      TRUE                           ~ factor(level)
    ),
    ### Outcome order for primary outcomes
    outcome_lab = factor(
      outcome_lab,
      levels = c(
        "Asthma",
        "Allergic rhinitis",
        "Inflammatory arthritis",
        "Diabetes",
        "Hypertension"
      )
    )
  ) |>
  arrange(
    outcome_lab,
    modifier_var,
    level
  )

effectmod_primary_display <- build_effectmod_display(effectmod_primary_long)

tbl_effectmod_primary <- effectmod_primary_display |>
  select(
    Outcome,
    `Modifier level`,
    `OR (95% CI)`,
    `p for interaction`
  ) |>
  gt(groupname_col = "Outcome") |>
  tab_header(
    title = md("**Table 9: Effect Modification of the Association Between Dietary Inflammatory Index and Asthma, Allergic Rhinitis, Inflammatory Arthritis, Diabetes, and Hypertension**")
  ) |>
  fmt_markdown(columns = everything()) |>
  cols_label(
    `Modifier level`    = md("**Modifier level**"),
    `OR (95% CI)`       = md("**OR (95% CI)**"),
    `p for interaction` = md("**p for interaction**")
  ) |>
  tab_options(table.font.size = px(10)) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  ) |>
  tab_footnote(
    footnote = "NE = not estimatable due to low event rates or unstable estimates",
    locations = cells_body(
      columns = "OR (95% CI)",
      rows    = `OR (95% CI)` == "NE"
    )
  )

## Effect modification for secondary outcomes
effectmod_secondary_long <- map_dfr(
  names(outcome_list_secondary),
  function(out_nm) {
    outcome_info <- outcome_list_secondary[[out_nm]]

    map_dfr(
      seq_len(nrow(effectmod_modifiers)),
      function(i) {
        mod_var   <- effectmod_modifiers$modifier_var[i]
        mod_label <- effectmod_modifiers$modifier_label[i]

        fit_int <- fit_dii_interaction_model(
          outcome_info    = outcome_info,
          covariates_base = covariates_m3,
          modifier_var    = mod_var
        )

        run_dii_effectmod(
          fit            = fit_int,
          outcome_label  = outcome_info$label,
          modifier_var   = mod_var,
          modifier_label = mod_label
        )
      }
    )
  }
) |>
  mutate(
    outcome_lab = recode(
      outcome_lab,
      "Atopic dermatitis" = "Eczema"
    ),
    `p for interaction` = ifelse(
      is.na(p_int),
      NA_character_,
      scales::pvalue(p_int, accuracy = 0.001)
    )
  )

effectmod_secondary_long <- effectmod_secondary_long |>
  mutate(
    modifier_var = factor(
      modifier_var,
      levels = c("sex", "bmi_cat", "vitD25oh_cat")
    ),
    level = as.character(level)
  ) |>
  mutate(
    level = case_when(
      modifier_var == "bmi_cat"      ~ factor(level, levels = bmi_level_order),
      modifier_var == "vitD25oh_cat" ~ factor(level, levels = vitD_level_order),
      TRUE                           ~ factor(level)
    ),
    ## Enforce outcome order for secondary outcomes:
    ## Eczema, Food allergy
    outcome_lab = factor(
      outcome_lab,
      levels = c(
        "Eczema",
        "Food allergy"
      )
    )
  ) |>
  arrange(
    outcome_lab,
    modifier_var,
    level
  )

effectmod_secondary_display <- build_effectmod_display(effectmod_secondary_long)

tbl_effectmod_secondary <- effectmod_secondary_display |>
  select(
    Outcome,
    `Modifier level`,
    `OR (95% CI)`,
    `p for interaction`
  ) |>
  gt(groupname_col = "Outcome") |>
  tab_header(
    title = md("**Table 10: Effect Modification of the Association Between Dietary Inflammatory Index and Eczema or Food Allergy**")
  ) |>
  fmt_markdown(columns = everything()) |>
  cols_label(
    `Modifier level`    = md("**Modifier level**"),
    `OR (95% CI)`       = md("**OR (95% CI)**"),
    `p for interaction` = md("**p for interaction**")
  ) |>
  tab_options(table.font.size = px(10)) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  ) |>
  tab_footnote(
    footnote = "NE = not estimatable due to low event rates or unstable estimates",
    locations = cells_body(
      columns = "OR (95% CI)",
      rows    = `OR (95% CI)` == "NE"
    )
  )

# Print effect modification tables-------------------------------------------------------------
tbl_effectmod_primary
tbl_effectmod_secondary
```

**Machine learning analyses**

Exploratory machine learning models were developed to identify predictors of disease beyond those detected in traditional regression analyses. For each outcome, four algorithms – namely LR, LASSO, RF, and XGB – were trained on one of two predictor sets: (1) core demographic, psychosocial, clinical, and dietary covariates, including the total DII score, and (2) quartiles of individual nutrient intakes. ROC curves (**Figures 4-5**) and AUROC values (**Tables 11–12**) summarize model performance for models with either core covariates or nutrients only, respectively. Diabetes demonstrated the strongest performance (AUROC 0.83–0.92), followed by hypertension (AUROC 0.72–0.76) and inflammatory arthritis (AUROC 0.64–0.76). Performance was more modest for allergic rhinitis (AUROC 0.62–0.66) and asthma (AUROC 0.61–0.62), and was notably lower for food allergy (AUROC 0.49–0.59) and eczema (AUROC 0.44–0.60). Across all outcomes, models trained using nutrient-intake quartiles showed minimal discriminative ability (AUROC 0.46–0.65).

Feature importance analyses were performed to acquire insight into potentially important predictors related to disease outcomes. In analyses with core covariate predictors (**Figures 6–12**), the DII score consistently ranked among the top 10 predictors for every disease outcome in at last three out of four models per disease outcome. For allergic and immunologic outcomes, DII scores, cardiometabolic factors, and psychosocial variables were influential predictors. For diabetes and hypertension, influential predictors included elevated HbA1c, elevated lipid markers, and adiposity. In contrast to the core covariate models, nutrient-only models (**Figures 16–19**) demonstrated inconsistent patterns across diseases. Nutrients such as polyunsaturated fatty acids (PUFAs), omega-6 fatty accids, caffeine, total caloric intake, iron, and B vitamins were observed but without a clear disease-specific consistency.

```{r}
# Model run options, outcome definitions, and helper functions---------------------------------
options(yardstick.event_first = "second") # second outcome is disease

## Trial mode. TRUE = abbreviated, trial run (3-fold CV, smaller grids) for exploratory analysis; FALSE = full run (10-fold CV, larger grids) for final analysis
trial_mode  <- FALSE
trial_max_n <- 2000  # maximum complete cases per outcome for trial runs

tidymodels_prefer()

ml_outcomes <- list(
  asthma = list(
    label      = "Asthma",
    data       = asthma_reg,
    outcome    = "asthma",
    is_primary = TRUE
  ),
  ar = list(
    label      = "Allergic rhinitis",
    data       = ar_reg,
    outcome    = "ar",
    is_primary = TRUE
  ),
  arthritis = list(
    label      = "Inflammatory arthritis",
    data       = inflam_reg,
    outcome    = "arthritis",
    is_primary = TRUE
  ),
  htn = list(
    label      = "Hypertension",
    data       = htn_reg,
    outcome    = "htn",
    is_primary = TRUE
  ),
  diabetes = list(
    label      = "Diabetes",
    data       = dm_reg,
    outcome    = "diabetes",
    is_primary = TRUE
  ),
  ad = list(
    label      = "Atopic dermatitis",
    data       = ad_reg,
    outcome    = "ad",
    is_primary = FALSE
  ),
  fa = list(
    label      = "Food allergy",
    data       = fa_reg,
    outcome    = "fa",
    is_primary = FALSE
  )
)

## Helper function to add trend variables
add_ml_trend_vars <- function(data) {
  ### Vitamin D trend
  if ("vitD25oh_cat" %in% names(data) && !"vitD25oh_cat_trend" %in% names(data)) {
    data <- data |>
      mutate(
        vitD25oh_cat_trend = if_else(
          !is.na(vitD25oh_cat),
          as.numeric(vitD25oh_cat) - 1,
          NA_real_
        )
      )
  }

  ### DII quartile trend
  if ("dii_quart" %in% names(data) && !"dii_quart_trend" %in% names(data)) {
    data <- data |>
      mutate(
        dii_quart_trend = if_else(
          !is.na(dii_quart),
          as.numeric(dii_quart) - 1,
          NA_real_
        )
      )
  }

  data
}

# Predictor sets-------------------------------------------------------------------------------
# Set 1 variabvles: core covariates
predictors_set1 <- c(
  "age",
  "sex",
  "race",
  "insur",
  "educ",
  "pir",
  "food_sec",
  "smoking",
  "phys_act",
  "alcohol",
  "sbp_cat",
  "dbp_cat",
  "bmi_cat",
  "whtr_cat",
  "hdl",
  "non_hdl",
  "tchol",
  "hba1c",
  "vitD25oh_cat",
  "vitD25oh_cat_trend",
  "dii",
  "dii_quart_trend",
  "dii_etoh"
)

# Set 2 variables: individual nutrient quartiles
predictors_set2 <- c(
  "kcal_quart", "carb_quart", "protein_quart", "totalfat_quart", "satfat_quart",
  "pufa_quart", "mufa_quart", "n3fat_quart", "n6fat_quart", "choles_quart",
  "vitA_quart", "bcarotene_quart", "vitC_quart", "vitE_quart",
  "vitB6_quart", "vitB12_quart", "folicacid_quart",
  "thiamin_quart", "riboflavin_quart", "niacin_quart",
  "iron_quart", "mg_quart", "zn_quart", "se_quart",
  "fiber_quart", "caffeine_quart"
)

# Helper functions-----------------------------------------------------------------------------
## Helper function to prepare ML data 
prepare_ml_data <- function(data, outcome, predictors) {

  ### Add trend scores
  data <- add_ml_trend_vars(data)

  ### Keep only outcome and predictors
  vars_keep <- intersect(c(outcome, predictors), names(data))

  df <- data |>
    select(all_of(vars_keep)) |>
    drop_na() |>
    mutate(
      !!outcome := factor(
        .data[[outcome]],
        levels = c(0, 1),
        labels = c("No", "Yes")
      )
    )

  ### For trial runs: sub-sample if enough events and keep all rows for rare outcomes
  if (trial_mode && nrow(df) > trial_max_n) {
    case_n <- sum(df[[outcome]] == "Yes")
    min_events_for_subsample <- 150L
    if (case_n >= min_events_for_subsample) {
      df <- slice_sample(df, n = trial_max_n)
    }
  }
  df
}

## Helper function to train/test-split data and perform cross-validation
set.seed(1234)

make_splits_and_folds <- function(df, outcome) {

  v_folds <- if (trial_mode) 3L else 10L

  split_obj <- initial_split(
    df,
    strata = !!rlang::sym(outcome),
    prop   = 0.8
  )

  train_df <- training(split_obj)
  test_df  <- testing(split_obj)

  folds <- vfold_cv(
    train_df,
    v      = v_folds,
    strata = !!rlang::sym(outcome)
  )

  list(
    split  = split_obj,
    train  = train_df,
    test   = test_df,
    folds  = folds
  )
}


## Helper function for recipes
make_ml_recipe <- function(df, outcome, predictors) {
  recipe(
    formula = stats::as.formula(paste(outcome, "~", ".")),
    data    = df
  ) |>
    step_dummy(all_nominal_predictors()) |>
    step_zv(all_predictors()) |>
    step_normalize(all_predictors())
}


# Model specifications-------------------------------------------------------------------------
lr_spec <-
  logistic_reg() |>
  set_engine("glm") |>
  set_mode("classification")

lasso_spec <-
  logistic_reg(
    penalty = tune(),
    mixture = 1
  ) |>
  set_engine("glmnet") |>
  set_mode("classification")

rf_spec_base <-
  rand_forest(
    trees = if (trial_mode) 500L else 1000L,
    mtry  = tune(),
    min_n = 5L
  ) |>
  set_engine("randomForest", importance = TRUE) |>
  set_mode("classification")

xgb_spec_base <-
  boost_tree(
    trees          = tune(),
    tree_depth     = tune(),
    learn_rate     = tune(),
    min_n          = 5L,
    sample_size    = 1.0,
    loss_reduction = 0
  ) |>
  set_mode("classification") |>
  set_engine("xgboost")


## Helper function for logistic regression metrics and variable importance
get_lr_vi <- function(lr_fit_workflow) {
  glm_fit <- extract_fit_engine(lr_fit_workflow)
  broom::tidy(glm_fit) |>
    filter(term != "(Intercept)") |>
    transmute(
      Variable   = term,
      Importance = abs(estimate),
      model      = "Logistic regression"
    )
}


# Machine learning pipeline -------------------------------------------------------------------
run_ml_pipeline <- function(predictors, predictor_set_label) {
  ## Datasets and sample sizes
  ml_data_list <- purrr::imap(
    ml_outcomes,
    ~ prepare_ml_data(
      data       = .x$data,
      outcome    = .x$outcome,
      predictors = predictors
    )
  )

  ml_sample_sizes <- purrr::imap_dfr(
    ml_data_list,
    ~ tibble(
      outcome        = .y,
      outcome_label  = ml_outcomes[[.y]]$label,
      N_ml           = nrow(.x),
      predictor_set  = predictor_set_label
    )
  )

  ml_sample_sizes_gt <- ml_sample_sizes |>
    gt() |>
    tab_header(
      title = paste0("ML analytic sample sizes by outcome — ", predictor_set_label)
    ) |>
    cols_label(
      outcome       = "Outcome (internal name)",
      outcome_label = "Outcome",
      N_ml          = "Complete-case N (ML)",
      predictor_set = "Predictor set"
    )

  ## Train/test splits and cross-validation folds
  ml_resampling <- purrr::imap(
    ml_data_list,
    ~ make_splits_and_folds(.x, outcome = ml_outcomes[[.y]]$outcome)
  )

  ## Recipes and feature counts
  ml_recipes <- purrr::imap(
    ml_resampling,
    ~ make_ml_recipe(
      df         = .x$train,
      outcome    = ml_outcomes[[.y]]$outcome,
      predictors = predictors
    )
  )

  ml_feature_counts <- purrr::imap_dfr(
    ml_recipes,
    ~ {
      prep_rec <- prep(.x)
      baked    <- juice(prep_rec)
      tibble(
        outcome        = .y,
        outcome_label  = ml_outcomes[[.y]]$label,
        n_features     = ncol(baked) - 1,
        predictor_set  = predictor_set_label
      )
    }
  )

  ml_feature_counts_gt <- ml_feature_counts |>
    gt() |>
    tab_header(
      title = paste0("Number of ML predictors after preprocessing — ", predictor_set_label)
    ) |>
    cols_label(
      outcome       = "Outcome (internal name)",
      outcome_label = "Outcome",
      n_features    = "Number of predictors",
      predictor_set = "Predictor set"
    )

  ## Tuning grids
  lasso_grid <- grid_regular(
    penalty(),
    levels = if (trial_mode) 5L else 30L
  )

  rf_grid <- grid_regular(
    mtry(range = c(5L, min(30L, length(predictors)))),
    levels = if (trial_mode) 3L else 5L
  )

  set.seed(1234)
  xgb_grid <- grid_latin_hypercube(
    trees(range = c(100L, 300L)),
    tree_depth(range = c(3L, 5L)),
    learn_rate(range = c(-2, -1)),
    size = if (trial_mode) 10L else 20L
  )

  ## Workflows per outcome
  make_workflows_for_outcome <- function(recipe_obj, outcome_name, train_df) {
    list(
      lr = workflow() |>
        add_model(lr_spec) |>
        add_recipe(recipe_obj),

      lasso = workflow() |>
        add_model(lasso_spec) |>
        add_recipe(recipe_obj),

      rf = workflow() |>
        add_model(rf_spec_base) |>
        add_recipe(recipe_obj),

      xgb = workflow() |>
        add_model(xgb_spec_base) |>
        add_recipe(recipe_obj)
    )
  }

  ml_workflows <- purrr::imap(
    ml_resampling,
    ~ make_workflows_for_outcome(
      recipe_obj   = ml_recipes[[.y]],
      outcome_name = .y,
      train_df     = .x$train
    )
  )

  ctrl_resamples <- control_grid(
    save_pred     = TRUE,
    parallel_over = "resamples",
    verbose       = TRUE
  )

  ## Model tuning and cross-validation for each outcome
  tune_models_for_outcome <- function(outcome_name) {
    resampling    <- ml_resampling[[outcome_name]]
    workflows_out <- ml_workflows[[outcome_name]]

    lr_res <- workflows_out$lr |>
      fit_resamples(
        resamples = resampling$folds,
        control   = control_resamples(save_pred = TRUE),
        metrics   = metric_set(
          roc_auc
        )
      )

    lasso_res <- workflows_out$lasso |>
      tune_grid(
        resamples = resampling$folds,
        grid      = lasso_grid,
        control   = ctrl_resamples,
        metrics   = metric_set(roc_auc)
      )

    rf_res <- workflows_out$rf |>
      tune_grid(
        resamples = resampling$folds,
        grid      = rf_grid,
        control   = ctrl_resamples,
        metrics   = metric_set(roc_auc)
      )

    xgb_res <- workflows_out$xgb |>
      tune_grid(
        resamples = resampling$folds,
        grid      = xgb_grid,
        control   = ctrl_resamples,
        metrics   = metric_set(roc_auc)
      )

    list(
      lr    = lr_res,
      lasso = lasso_res,
      rf    = rf_res,
      xgb   = xgb_res
    )
  }

  set.seed(1234)
  ml_tuning_results <- purrr::imap(
    ml_outcomes,
    ~ tune_models_for_outcome(.y)
  )

  ## Best hyperparameters
  get_best_params <- function(tune_res) {
    list(
      lasso = select_best(tune_res$lasso, metric = "roc_auc"),
      rf    = select_best(tune_res$rf,    metric = "roc_auc"),
      xgb   = select_best(tune_res$xgb,   metric = "roc_auc")
    )
  }

  ml_best_params <- purrr::imap(
    ml_tuning_results,
    ~ get_best_params(.x)
  )

  ## Final model fits and test set performance
  fit_and_evaluate_final_models <- function(outcome_name) {
    outcome_info  <- ml_outcomes[[outcome_name]]
    resampling    <- ml_resampling[[outcome_name]]
    workflows_out <- ml_workflows[[outcome_name]]
    best_pars     <- ml_best_params[[outcome_name]]
    outcome_var   <- outcome_info$outcome

    train_df <- resampling$train
    test_df  <- resampling$test

    ### Logistic regression
    final_lr_fit <- workflows_out$lr |>
      fit(data = train_df)

    lr_preds_test <- bind_cols(
      truth = test_df[[outcome_var]],
      predict(final_lr_fit, test_df),
      predict(final_lr_fit, test_df, type = "prob")
    )

    lr_metrics <- roc_auc(
      lr_preds_test,
      truth,
      .pred_Yes,
      event_level = "second"
    ) |>
      mutate(
        outcome          = outcome_info$label,
        model            = "Logistic regression",
        set              = "Full predictors",
        outcome_internal = outcome_name,
        predictor_set    = predictor_set_label
      )

    ### LASSO
    final_lasso_wf <- workflows_out$lasso |>
      finalize_workflow(best_pars$lasso)

    final_lasso_fit <- final_lasso_wf |>
      fit(data = train_df)

    lasso_preds_test <- bind_cols(
      truth = test_df[[outcome_var]],
      predict(final_lasso_fit, test_df),
      predict(final_lasso_fit, test_df, type = "prob")
    )

    lasso_metrics <- roc_auc(
      lasso_preds_test,
      truth,
      .pred_Yes,
      event_level = "second"
    ) |>
      mutate(
        outcome          = outcome_info$label,
        model            = "LASSO",
        set              = "Full predictors",
        outcome_internal = outcome_name,
        predictor_set    = predictor_set_label
      )

    ### Random forest
    final_rf_wf <- workflows_out$rf |>
      finalize_workflow(best_pars$rf)

    final_rf_fit <- final_rf_wf |>
      fit(data = train_df)

    rf_preds_test <- bind_cols(
      truth = test_df[[outcome_var]],
      predict(final_rf_fit, test_df),
      predict(final_rf_fit, test_df, type = "prob")
    )

    rf_metrics <- roc_auc(
      rf_preds_test,
      truth,
      .pred_Yes,
      event_level = "second"
    ) |>
      mutate(
        outcome          = outcome_info$label,
        model            = "Random forest",
        set              = "Full predictors",
        outcome_internal = outcome_name,
        predictor_set    = predictor_set_label
      )

    ### XGBoost
    final_xgb_wf <- workflows_out$xgb |>
      finalize_workflow(best_pars$xgb)

    final_xgb_fit <- final_xgb_wf |>
      fit(data = train_df)

    xgb_preds_test <- bind_cols(
      truth = test_df[[outcome_var]],
      predict(final_xgb_fit, test_df),
      predict(final_xgb_fit, test_df, type = "prob")
    )

    xgb_metrics <- roc_auc(
      xgb_preds_test,
      truth,
      .pred_Yes,
      event_level = "second"
    ) |>
      mutate(
        outcome          = outcome_info$label,
        model            = "XGBoost",
        set              = "Full predictors",
        outcome_internal = outcome_name,
        predictor_set    = predictor_set_label
      )

    list(
      metrics = bind_rows(
        lr_metrics,
        lasso_metrics,
        rf_metrics,
        xgb_metrics
      ),
      preds = list(
        lr    = lr_preds_test,
        lasso = lasso_preds_test,
        rf    = rf_preds_test,
        xgb   = xgb_preds_test
      ),
      final_fits = list(
        lr    = final_lr_fit,
        lasso = final_lasso_fit,
        rf    = final_rf_fit,
        xgb   = final_xgb_fit
      )
    )
  }

  ml_final_results <- purrr::imap(
    ml_outcomes,
    ~ fit_and_evaluate_final_models(.y)
  )

  ### Performance summary data
  ml_performance_summary_long <- purrr::map_dfr(
    names(ml_final_results),
    ~ ml_final_results[[.x]]$metrics
  )

  ml_performance_table <- ml_performance_summary_long |>
    select(
      predictor_set,
      outcome_internal,
      outcome,
      model,
      set,
      .metric,
      .estimate
    ) |>
    pivot_wider(
      id_cols     = c(predictor_set, outcome_internal, outcome, model, set),
      names_from  = .metric,
      values_from = .estimate
    ) |>
    rename(
      AUROC = roc_auc
    ) |>
    arrange(outcome, desc(AUROC))

  ml_performance_table_gt <- ml_performance_table |>
    gt(rowname_col = "model", groupname_col = "outcome") |>
    tab_header(
      title = paste0("Test-set performance of ML models by outcome — ",
                     predictor_set_label)
    ) |>
    fmt_number(
      columns = c(AUROC),
      decimals = 3
    ) |>
    cols_label(
      predictor_set    = "Predictor set",
      outcome_internal = "Outcome (internal)",
      outcome          = "Outcome",
      set              = "Predictor usage",
      AUROC            = "AUROC"
    )

  ### Variable importance data
  get_vi_all_models_for_outcome <- function(outcome_name) {
    fits <- ml_final_results[[outcome_name]]$final_fits

    lr_vi <- get_lr_vi(fits$lr)

    lasso_vi <- vip::vi(fits$lasso) |>
      mutate(
        model    = "LASSO",
        Variable = as.character(Variable)
      )

    rf_vi <- vip::vi(fits$rf) |>
      mutate(
        model    = "Random forest",
        Variable = as.character(Variable)
      )

    xgb_vi <- vip::vi(fits$xgb) |>
      mutate(
        model    = "XGBoost",
        Variable = as.character(Variable)
      )

    bind_rows(lr_vi, lasso_vi, rf_vi, xgb_vi)
  }

  ml_vi_all <- purrr::imap(
    ml_outcomes,
    ~ get_vi_all_models_for_outcome(.y)
  )

  ### Pipeline outputs
  list(
    predictor_set_label      = predictor_set_label,
    predictors               = predictors,
    ml_sample_sizes          = ml_sample_sizes,
    ml_sample_sizes_gt       = ml_sample_sizes_gt,
    ml_feature_counts        = ml_feature_counts,
    ml_feature_counts_gt     = ml_feature_counts_gt,
    ml_data_list             = ml_data_list,
    ml_resampling            = ml_resampling,
    ml_recipes               = ml_recipes,
    ml_tuning_results        = ml_tuning_results,
    ml_best_params           = ml_best_params,
    ml_final_results         = ml_final_results,
    ml_performance_table     = ml_performance_table,
    ml_performance_table_gt  = ml_performance_table_gt,
    ml_vi_all                = ml_vi_all
  )
}

# Run machine learning pipelines for set 1 (core covariates) and set 2 (individual nutritional covariates)------------------------------------------------------------------------------------
results_set1 <- run_ml_pipeline(
  predictors          = predictors_set1,
  predictor_set_label = "Set 1: main regression predictors"
)

results_set2 <- run_ml_pipeline(
  predictors          = predictors_set2,
  predictor_set_label = "Set 2: nutrient quartiles"
)

ml_performance_all_stage1 <- bind_rows(
  results_set1$ml_performance_table,
  results_set2$ml_performance_table
)

# ROC curves-----------------------------------------------------------------------------------
## ROC curves for all outcomes by predictors
make_roc_panel <- function(results_obj, title_text) {

  desired_order <- c(
    "Asthma",
    "Allergic rhinitis",
    "Inflammatory\narthritis",
    "Diabetes",
    "Hypertension",
    "Eczema",
    "Food allergy"
  )

  outcome_label_map <- c(
    asthma    = "Asthma",
    ar        = "Allergic rhinitis",
    arthritis = "Inflammatory\narthritis",
    diabetes  = "Diabetes",
    htn       = "Hypertension",
    ad        = "Eczema",
    fa        = "Food allergy"
  )

  ### Model color mapping
  custom_colors <- c(
    "LR"    = "#E69F00",  # logistic regression
    "Lasso" = "#009E73",  # LASSO
    "RF"    = "#0072B2",  # random forest
    "XGB"   = "#CC79A7"   # XGBoost
  )

  outcome_names <- names(ml_outcomes)

  roc_long <- purrr::map_dfr(
    outcome_names,
    function(out_nm) {
      preds         <- results_obj$ml_final_results[[out_nm]]$preds
      outcome_label <- outcome_label_map[[out_nm]]

      bind_rows(
        roc_curve(preds$lr,    truth, .pred_Yes, event_level = "second") |>
          mutate(model = "LR"),
        roc_curve(preds$lasso, truth, .pred_Yes, event_level = "second") |>
          mutate(model = "Lasso"),
        roc_curve(preds$rf,    truth, .pred_Yes, event_level = "second") |>
          mutate(model = "RF"),
        roc_curve(preds$xgb,   truth, .pred_Yes, event_level = "second") |>
          mutate(model = "XGB")
      ) |>
        mutate(
          outcome = factor(outcome_label, levels = desired_order)
        )
    }
  )

  ggplot(
    roc_long,
    aes(x = 1 - specificity, y = sensitivity, color = model)
  ) +
    geom_line(linewidth = 0.9) +
    geom_abline(linetype = "dashed") +
    coord_equal() +
    facet_wrap(~ outcome, ncol = 5, drop = FALSE) +
    labs(
      title = title_text,
      x     = "1 − Specificity",
      y     = "Sensitivity",
      color = "Model"
    ) +
    scale_color_manual(
      values = custom_colors,
      breaks = c("LR", "Lasso", "RF", "XGB")
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title   = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.title.x = element_text(size = 12, face = "bold"),
      axis.title.y = element_text(size = 12, face = "bold"),
      legend.position = "bottom",
      legend.title    = element_text(size = 12, face = "bold"),
      legend.text     = element_text(size = 12),
      strip.text      = element_text(size = 12, face = "bold"),
      panel.spacing.x = grid::unit(1.2, "lines"),
      panel.spacing.y = grid::unit(1.2, "lines")
    )
}

## ROC curves for models with core covariates
roc_panel_set1 <- make_roc_panel(
  results_set1,
  "Figure 4: Receiver Operating Characteristic Curves\nfor Machine Learning Models With Core Covariates"
)

## ROC curves for models with individual nutritional covariates
roc_panel_set2 <- make_roc_panel(
  results_set2,
  "Figure 5: Receiver Operating Characteristic Curves\nfor Machine Learning Models With Individual Nutritional Covariates"
)

# Machine learning model performance summary tables -------------------------------------------
## Desired outcome order
desired_outcome_order <- c(
  "Asthma",
  "Allergic rhinitis",
  "Inflammatory arthritis",
  "Diabetes",
  "Hypertension",
  "Eczema",
  "Food allergy"
)

## Core covariates performance summary (set 1)
core_perf <- results_set1$ml_performance_table |>
  mutate(
    outcome = recode(outcome, "Atopic dermatitis" = "Eczema"),
    outcome = factor(outcome, levels = desired_outcome_order),
    model   = factor(
      model,
      levels = c(
        "Logistic regression",
        "LASSO",
        "Random forest",
        "XGBoost"
      )
    )
  ) |>
  arrange(outcome, model)

core_perf_gt <- core_perf |>
  select(
    outcome,
    model,
    AUROC
  ) |>
  gt(rowname_col = "model", groupname_col = "outcome") |>
  tab_header(
    title = md("**Table 11: Machine Learning Model Performance Summary for Models With Core Covariates**")
  ) |>
  fmt_number(
    columns = c(AUROC),
    decimals = 3
  ) |>
  cols_label(
    outcome = md("**Disease**"),
    model   = md("**Model**"),
    AUROC   = md("**AUROC**")
  ) |>
  tab_options(
    table.width = pct(70)
  ) |>
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = list(
      cells_title("title"),
      cells_column_labels(everything()),
      cells_row_groups()
    )
  )

## Individual nutritional covariates performance summary (set 2)
nutr_perf <- results_set2$ml_performance_table |>
  mutate(
    outcome = recode(outcome, "Atopic dermatitis" = "Eczema"),
    outcome = factor(outcome, levels = desired_outcome_order),
    model   = factor(
      model,
      levels = c(
        "Logistic regression",
        "LASSO",
        "Random forest",
        "XGBoost"
      )
    )
  ) |>
  arrange(outcome, model)

nutr_perf_gt <- nutr_perf |>
  select(
    outcome,
    model,
    AUROC
  ) |>
  gt(rowname_col = "model", groupname_col = "outcome") |>
  tab_header(
    title = md("**Table 12: Machine Learning Model Performance Summary for Models With Individual Nutritional Covariates**")
  ) |>
  fmt_number(
    columns = c(AUROC),
    decimals = 3
  ) |>
  cols_label(
    outcome = md("**Disease**"),
    model   = md("**Model**"),
    AUROC   = md("**AUROC**")
  ) |>
  tab_options(
    table.width = pct(70)
  ) |>
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = list(
      cells_title("title"),
      cells_column_labels(everything()),
      cells_row_groups()
    )
  )


# Settings for ranked variable importance figures----------------------------------------------
## Disease-specific color map
disease_color_map <- c(
  "Asthma"                 = "#5E3C99",
  "Allergic Rhinitis"      = "#89CFF0",
  "Inflammatory Arthritis" = "#009E73",
  "Diabetes"               = "#F0E442",
  "Hypertension"           = "#D55E00",
  "Eczema"                 = "#E78AC3",
  "Food Allergy"           = "#4B2E0F"
)

make_vi_plot_single <- function(results_obj,
                                outcome_name,
                                disease_title,
                                predictor_set_desc,
                                figure_label,
                                top_n = 10) {

  vi_df <- results_obj$ml_vi_all[[outcome_name]]

  vi_df <- vi_df |>
    filter(!is.na(Importance), Importance != 0)

  vi_df <- vi_df |>
    mutate(
      model = factor(
        model,
        levels = c(
          "Logistic regression",
          "LASSO",
          "Random forest",
          "XGBoost"
        )
      )
    )

  vi_plot_df <- vi_df |>
    group_by(model) |>
    slice_max(order_by = Importance, n = top_n, with_ties = FALSE) |>
    arrange(Importance, .by_group = TRUE) |>
    mutate(
      Variable_plot = paste(model, Variable, sep = "__"),
      Variable_plot = factor(Variable_plot, levels = unique(Variable_plot))
    ) |>
    ungroup()

  ggplot(
    vi_plot_df,
    aes(x = Importance, y = Variable_plot)
  ) +
    geom_col(fill = disease_color_map[disease_title]) +
    facet_wrap(~ model, scales = "free") +
    scale_y_discrete(
      labels = function(x) sub("^[^_]+__", "", x)
    ) +
    labs(
      title = paste0(
        figure_label,
        ": Ranked Feature Importance of ",
        predictor_set_desc,
        "\nin Machine Learning Models for ",
        disease_title
      ),
      x = "Importance",
      y = "Predictor"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title   = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.title.x = element_text(size = 12, face = "bold"),
      axis.title.y = element_text(size = 12, face = "bold"),
      strip.text   = element_text(size = 11, face = "bold"),
      panel.spacing = grid::unit(1, "lines")
    )
}

disease_title_map <- c(
  asthma    = "Asthma",
  ar        = "Allergic Rhinitis",
  arthritis = "Inflammatory Arthritis",
  diabetes  = "Diabetes",
  htn       = "Hypertension",
  ad        = "Eczema",
  fa        = "Food Allergy"
)

core_figure_labels <- c(
  asthma    = "Figure 6",
  ar        = "Figure 7",
  arthritis = "Figure 8",
  diabetes  = "Figure 9",
  htn       = "Figure 10",
  ad        = "Figure 11",
  fa        = "Figure 12"
)

nutr_figure_labels <- c(
  asthma    = "Figure 13",
  ar        = "Figure 14",
  arthritis = "Figure 15",
  diabetes  = "Figure 16",
  htn       = "Figure 17",
  ad        = "Figure 18",
  fa        = "Figure 19"
)

# Generate core covariate (set 1) variable importance plots------------------------------------
vi_core_plots <- purrr::imap(
  disease_title_map,
  ~ make_vi_plot_single(
      results_obj        = results_set1,
      outcome_name       = .y,
      disease_title      = .x,
      predictor_set_desc = "Core Covariates",
      figure_label       = core_figure_labels[[.y]]
    )
)

vi_core_asthma       <- vi_core_plots$asthma      # Figure 6
vi_core_ar           <- vi_core_plots$ar          # Figure 7
vi_core_arthritis    <- vi_core_plots$arthritis   # Figure 8
vi_core_diabetes     <- vi_core_plots$diabetes    # Figure 9
vi_core_htn          <- vi_core_plots$htn         # Figure 10
vi_core_eczema       <- vi_core_plots$ad          # Figure 11
vi_core_food_allergy <- vi_core_plots$fa          # Figure 12

# Generate individual nutritional covariate (set 2) variable importance plots -----------------
vi_nutr_plots <- purrr::imap(
  disease_title_map,
  ~ make_vi_plot_single(
      results_obj        = results_set2,
      outcome_name       = .y,
      disease_title      = .x,
      predictor_set_desc = "Individual Nutritional Covariates",
      figure_label       = nutr_figure_labels[[.y]]
    )
)

vi_nutr_asthma       <- vi_nutr_plots$asthma      # Figure 13
vi_nutr_ar           <- vi_nutr_plots$ar          # Figure 14
vi_nutr_arthritis    <- vi_nutr_plots$arthritis   # Figure 15
vi_nutr_diabetes     <- vi_nutr_plots$diabetes    # Figure 16
vi_nutr_htn          <- vi_nutr_plots$htn         # Figure 17
vi_nutr_eczema       <- vi_nutr_plots$ad          # Figure 18
vi_nutr_food_allergy <- vi_nutr_plots$fa          # Figure 19

# Print ML tables and figures------------------------------------------------------------------
## Core covariates performance summary
core_perf_gt

## Individual nutritional covariates performance summary
nutr_perf_gt

## ROC panels
print(roc_panel_set1)
print(roc_panel_set2)

## Core covariates variable importance
print(vi_core_asthma)
print(vi_core_ar)
print(vi_core_arthritis)
print(vi_core_diabetes)
print(vi_core_htn)
print(vi_core_eczema)
print(vi_core_food_allergy)

## Individual nutritional covariates variable importance
print(vi_nutr_asthma)
print(vi_nutr_ar)
print(vi_nutr_arthritis)
print(vi_nutr_diabetes)
print(vi_nutr_htn)
print(vi_nutr_eczema)
print(vi_nutr_food_allergy)
```

## Conclusion and Discussion

In this nationally representative cohort of U.S. adults aged 20–40 years, I evaluated whether dietary inflammatory content, measured via the Dietary Inflammatory Index, was associated with allergic, immunologic, and cardiometabolic outcomes. This was performed using both survey-weighted regression and exploratory machine learning analyses. In regression analyses, modest signals for increased risk of allergic, immunologic, and/or cardiometabolic disease and pro-inflammatory diet were detected, but these associations were largely attenuated after adjustment for sociodemographic, behavioral, and anthropometric factors. Nutrient-specific analyses identified a few potentially protective micro- and macronutrients, though most associations were modest and not consistently significant. Interestingly, in machine learning models, DII consistently ranked among the top predictors in models that included core covariates from multiple domains, although machine learning model findings should be interpreted with caution given they were not robust in their predictive performance. Overall while DII may not independently predict diseases, it likely plays an incremental role in driving these diseases.

This study has several strengths, including use of nationally representative NHANES data with implementation of survey weighting, inclusion of a validated dietary inflammatory score and nutrient composition database, and the use of complementary analytic approaches to capture both adjusted associations and potentially important, machine learning-derived predictors. However, several important limitations must be acknowledged. First, the study’s cross-sectional design precludes causal inference. Second, the accuracy of self-reported medical diagnoses and 24-hour dietary recalls may be inaccurate. Moreover, self-reported eczema and food allergy were only available in restricted NHANES cycles, a reflection of survey cycle heterogeneity and shifting survey priorities. As analyses relied on complete cases, the potential impact of missing data on the results is unclear. For the machine learning models, several outcomes yielded AUROC values near 0.5, indicating limited predictive performance ability. In addition, the cross-sectional nature of the study limited the ability of these models to capture temporal patterns.

Future directions for this work include examining broader age ranges and a wider set of candidate diseases to further characterize how dietary inflammatory potential relates to risk across the lifespan. Longitudinal cohort studies, in which dietary patterns and clinical outcomes are tracked over time, would offer a complementary approach for addressing these questions and could be paired with multi-omic data, such as immune and metabolic biomarkers and microbiome profiles. In addition, future machine learning models could focus on enhancing model performance by identifying a more predictive set of features beyond those considered in the current analysis. Continued study and refinement of disease risk models that integrate dietary information may reveal insights to inform prevention and management strategies for chronic immune-mediated and metabolic diseases.

## References

\[1\] Annesi-Maesano I, Fleddermann M, Hornef M, et al. Allergic diseases in infancy: Epidemiology and current interpretation. *World Allergy Organ J.* 2021;14(11):100591.

\[2\] Boddu SK, Giannini C, Marcovecchio ML. Metabolic disorders in young people around the world. *Diabetologia.*2025;68(11):2374–2385.

\[3\] Kim H, Sitarik AR, Woodcroft K, Johnson CC, Zoratti E. Birth mode, breastfeeding, pet exposure, and antibiotics: Associations with the gut microbiome and sensitization. *Curr Allergy Asthma Rep.* 2019;19(4):22.

\[4\] Sbihi H, Boutin RC, Cutler C, Suen M, Finlay BB, Turvey SE. How early-life environmental exposures shape the gut microbiome and influence allergic disease. *Allergy.* 2019;74(11):2103–2115.

\[5\] Kuniyoshi Y, Tsujimoto Y, Banno M, et al. Association of obesity or metabolic syndrome with allergic diseases: Overview of reviews. *Obes Rev.* 2025;26(3):e13862.

\[6\] Chang CL, Ali GB, Pham J, et al. Childhood BMI trajectories and asthma and allergies: A systematic review. *Clin Exp Allergy.* 2023;53(9):911–929.

\[7\] Centers for Disease Control and Prevention (CDC), National Center for Health Statistics (NCHS). National Health and Nutrition Examination Survey Data, 2005–2012. Hyattsville, MD: US Department of Health and Human Services. Available from: <https://wwwn.cdc.gov/nchs/nhanes/>

\[8\] Xu Z. Improving the dietaryindex R package: A proposal to include additional components for more accurate DII computation in NHANES. *Am J Clin Nutr.* 2025 Jan;121(1):174–175. Epub 2024 Nov 9.

\[9\] Zhan JJ, Hodge RA, Dunlop AL, Lee MM, Bui L, Liang D, Ferranti EP. Dietaryindex: a user-friendly and versatile R package for standardizing dietary pattern analysis in epidemiological and clinical studies. *Am J Clin Nutr.* 2024 Nov;120(5):1165–1174. Epub 2024 Aug 23.

\[10\] Qing L, Zhu Y, Yu C, Zhang Y, Ni J. Exploring the association between dietary Inflammatory Index and chronic pain in US adults using NHANES 1999-2004. *Sci Rep*. 2024 Apr 16;14(1):8726.

## Acknowledgements

I would like to thank Drs. Robert Grundmeier and Rich Tsui for their guidance on the analytic and methodological approaches used in this study. I am also grateful to the BMIN 5030 professors and teaching assistants for helping me expand my foundation in data analysis throughout the course. In addition to consulting with my mentors, several references and tools were utilized to aid in completing this project, including prior course lecture slides, practicum exercises, and online troubleshooting resources including Stack Overflow, Posit Forum, and ChatGPT (OpenAI). Selective assistance from ChatGPT was used for debugging and developing helper functions to automate repetitive data processing tasks as I refined the cohort. All analytic decisions, data processing, modeling choices, and code were conceptualized, implemented, and reviewed by me with input from my co-mentors. I also wish to acknowledge the [dietaryindexNDP](https://github.com/zxucmu/dietaryindexNDP) package, which enabled calculation of DII scores that were key to this analysis.
